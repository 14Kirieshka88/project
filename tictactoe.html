<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö—Ä–µ—Å—Ç–∏–∫–∏-–ù–æ–ª–∏–∫–∏ Deluxe</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1f2937">

    <style>
        :root {
            --main-bg: #1f2937; /* –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π */
            --container-bg: #374151; /* –°—Ä–µ–¥–Ω–µ-—Å–µ—Ä—ã–π */
            --button-bg: #4f46e5; /* –Ø—Ä–∫–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π */
            --button-hover-bg: #6366f1;
            --x-color: #ef4444; /* –Ø—Ä–∫–æ-–∫—Ä–∞—Å–Ω—ã–π */
            --o-color: #3b82f6; /* –Ø—Ä–∫–æ-—Å–∏–Ω–∏–π */
            --text-color: #f3f4f6; /* –û—á–µ–Ω—å —Å–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π */
            --border-color: #6b7280; /* –°–µ—Ä—ã–π –¥–ª—è –ª–∏–Ω–∏–π */
            --shadow-color: rgba(0, 0, 0, 0.6);
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;

            /* –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ñ–æ–Ω–∞ —Ç–µ–ª–∞ */
            --body-bg-start: #111827;
            --body-bg-end: var(--main-bg);
            --body-bg-direction: 135deg;
            --body-bg-size: auto; /* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ */
            --body-bg-animation: none; /* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏—è */

            /* –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–µ–≤—å—é —Ç–µ–º */
            --preview-x-color: var(--x-color);
            --preview-o-color: var(--o-color);
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(var(--body-bg-direction), var(--body-bg-start) 0%, var(--body-bg-end) 100%);
            background-size: var(--body-bg-size); /* –î–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ */
            animation: var(--body-bg-animation); /* –î–ª—è –∞–Ω–∏–º–∞—Ü–∏—è */

            font-family: var(--font-family);
            color: var(--text-color);
            overflow: hidden;
            transition: background 0.5s ease; /* –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É —Ñ–æ–Ω–∞–º–∏ */
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è —Ñ–æ–Ω–∞ (–ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è, –µ—Å–ª–∏ --body-bg-animation –Ω–µ 'none') */
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .screen {
            display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç–∫—Ä–∞–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 90%;
            max-width: 500px; /* –£–≤–µ–ª–∏—á–µ–Ω–∞ —à–∏—Ä–∏–Ω–∞ */
            padding: 25px;
            background-color: var(--container-bg);
            border-radius: 20px;
            box-shadow: 0 20px 40px var(--shadow-color);
            text-align: center;
            box-sizing: border-box;
        }

        .screen.active {
            display: flex; /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç–∫—Ä–∞–Ω */
        }

        h1, h2 {
            color: var(--text-color);
            text-shadow: 0 0 8px rgba(255,255,255,0.3);
        }
        h1 { font-size: 2.8em; margin-bottom: 30px; }
        h2 { font-size: 2em; margin-bottom: 20px; }


        .menu-button, .back-button, .action-button {
            background-color: var(--button-bg);
            color: var(--text-color);
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            margin: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
            width: 250px;
            text-align: center;
        }

        .menu-button:hover, .back-button:hover, .action-button:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-3px);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è */
        .board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 300px;
            height: 300px;
            gap: 8px;
            background-color: var(--main-bg);
            padding: 8px;
            border-radius: 12px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.4), 0 3px 8px var(--shadow-color);
            margin-bottom: 20px;
        }

        .cell {
            background-color: var(--container-bg); /* –¢–µ–º–Ω–µ–µ, —á–µ–º —Ñ–æ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–≥—Ä—ã */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column; /* –î–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –∏ —Å–∏–º–≤–æ–ª–∞ */
            align-items: center;
            justify-content: center;
            font-size: 3.5em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2) inset, 0 1px 1px rgba(255,255,255,0.05);
            position: relative; /* –î–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–º–µ—Ä–∞ */
        }

        .cell:hover {
            background-color: #4b5563; /* –ß—É—Ç—å —Å–≤–µ—Ç–ª–µ–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        }

        /* –ù–æ–º–µ—Ä –Ω–∞ –ø–ª–∏—Ç–∫–µ */
        .cell .cell-number {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.4em; /* –ú–µ–Ω—å—à–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ */
            color: rgba(255, 255, 255, 0.3); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π */
            opacity: 1;
            transition: opacity 0.2s ease;
            pointer-events: none; /* –ß—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª –∫–ª–∏–∫–∞–º */
        }

        .cell.x .cell-number,
        .cell.o .cell-number {
            opacity: 0; /* –°–∫—Ä—ã–≤–∞–µ–º –Ω–æ–º–µ—Ä –ø–æ—Å–ª–µ —Ö–æ–¥–∞ */
        }

        /* –¶–≤–µ—Ç –∏ —Å—Ç–∏–ª—å —Å–∏–º–≤–æ–ª–æ–≤ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ç–µ–∫—É—â–µ–π —Ç–µ–º—ã */
        .cell .player-mark {
            opacity: 0;
            transform: scale(0.5);
            animation: appear 0.3s ease-out forwards;
            color: inherit; /* –¶–≤–µ—Ç –±—É–¥–µ—Ç –Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å—Å—è –æ—Ç .x –∏–ª–∏ .o */
            text-shadow: 0 0 7px currentColor, 0 0 3px black;
        }

        .cell.x .player-mark { color: var(--x-color); }
        .cell.o .player-mark { color: var(--o-color); }

        @keyframes appear {
            to { opacity: 1; transform: scale(1); }
        }

        .status {
            margin-bottom: 15px;
            font-size: 1.4em;
            min-height: 1.4em;
        }

        button#resetButtonGame {
            background: linear-gradient(145deg, var(--x-color), var(--o-color));
            color: var(--text-color);
            border: none;
            border-radius: 10px;
            padding: 12px 25px;
            font-size: 1.1em;
            font-weight: bold;
            margin-top:10px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s ease;
            box-shadow: 0 4px 8px var(--shadow-color);
        }
        button#resetButtonGame:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 12px var(--shadow-color);
        }

        /* –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä */
        #historyList {
            list-style: none;
            padding: 0;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        #historyList li {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            background-color: #4b5563;
        }
        #historyList li:last-child {
            border-bottom: none;
        }
        #historyList li:nth-child(odd) {
            background-color: var(--container-bg);
        }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –¢–µ–º --- */
        #themesScreen .themes-category {
            width: 100%;
            margin-bottom: 25px;
        }
        #themesScreen .themes-category h3 {
            color: var(--text-color);
            font-size: 1.6em;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 5px;
            text-align: left;
            width: 100%;
        }

        #themesScreen .themes-category.event-themes h3 {
            color: gold; /* –ó–æ–ª–æ—Ç–æ–π —Ü–≤–µ—Ç –¥–ª—è —ç–≤–µ–Ω—Ç–Ω—ã—Ö —Ç–µ–º */
            border-color: gold;
            text-shadow: 0 0 8px gold;
        }


        #themesScreen .themes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            width: 100%;
        }

        #themesScreen .themes-container { /* –ù–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
            width: 100%;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
            box-sizing: border-box;
        }
        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–æ—Å—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ (Webkit) */
        #themesScreen .themes-container::-webkit-scrollbar {
            width: 8px;
        }
        #themesScreen .themes-container::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 10px;
        }
        #themesScreen .themes-container::-webkit-scrollbar-thumb {
            background: var(--button-bg);
            border-radius: 10px;
        }
        #themesScreen .themes-container::-webkit-scrollbar-thumb:hover {
            background: var(--button-hover-bg);
        }


        #themesScreen .theme-option {
            background-color: var(--main-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1em;
            font-weight: bold;
            color: var(--text-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        #themesScreen .theme-option:hover {
            transform: translateY(-3px);
            border-color: var(--button-hover-bg);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

         #themesScreen .theme-option.selected {
            border-color: var(--button-bg);
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--button-bg), 0 0 8px var(--button-bg);
        }

        #themesScreen .theme-option.selected.event-theme { /* –°—Ç–∏–ª—å –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —ç–≤–µ–Ω—Ç–Ω–æ–π —Ç–µ–º—ã */
            border-color: gold;
            box-shadow: 0 0 15px gold, 0 0 8px gold;
        }


        #themesScreen .theme-preview {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
            background-color: var(--container-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
        }

        #themesScreen .theme-preview .preview-x,
        #themesScreen .theme-preview .preview-o {
            position: absolute;
            font-size: 1.8em;
            font-weight: bold;
            text-shadow: 0 0 4px rgba(0,0,0,0.5);
        }
        #themesScreen .theme-preview .preview-x {
            color: var(--preview-x-color);
            top: 5px; left: 5px;
        }
        #themesScreen .theme-preview .preview-o {
            color: var(--preview-o-color);
            bottom: 5px; right: 5px;
        }
        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è "—Å–∫—É—á–Ω—ã—Ö —É—Ä–æ–∫–æ–≤" */
        #themesScreen .theme-preview.boring-lessons .preview-x {
             color: black;
             font-weight: normal;
             opacity: 0.8;
             transform: scaleX(0.8) rotate(-45deg);
        }
        #themesScreen .theme-preview.boring-lessons .preview-o {
             color: black;
             font-weight: normal;
             opacity: 0.8;
             transform: scale(0.9);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –≤–µ—Ä—Å–∏–∏ –∏ –∞–≤—Ç–æ—Ä—Å—Ç–≤–∞ */
        #versionInfo {
            margin-top: 20px;
            font-size: 1em;
            color: rgba(255, 255, 255, 0.6); /* –ü—Ä–æ–∑—Ä–∞—á–Ω–æ-–±–µ–ª–æ–≤–∞—Ç—ã–π */
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            gap: 5px; /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏ */
        }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--container-bg);
            margin: auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px; /* –£–≤–µ–ª–∏—á–µ–Ω–∞ —à–∏—Ä–∏–Ω–∞ */
            box-shadow: 0 10px 30px var(--shadow-color);
            text-align: center;
            position: relative;
            max-height: 80vh; /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
            overflow-y: auto; /* –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –º–æ–¥–∞–ª–∫–∏ */
            box-sizing: border-box;
        }
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: var(--button-bg);
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: var(--button-hover-bg);
        }


        .modal-content h3 {
            color: var(--text-color);
            margin-bottom: 25px;
            font-size: 1.8em;
        }

        .modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 25px;
        }

        .modal-buttons .menu-button {
            width: 100%;
        }

        .close-button {
            position: absolute;
            top: 15px;
            right: 20px;
            color: var(--text-color);
            font-size: 2em;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .close-button:hover {
            color: var(--button-hover-bg);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö */
        .language-option {
            display: block; /* –ö–∞–∂–¥–∞—è –æ–ø—Ü–∏—è –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ */
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 8px;
            background-color: #4b5563;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            text-align: left;
        }
        .language-option:hover {
            background-color: #606b7a;
            border-color: var(--button-bg);
        }
        .language-option.selected-lang {
            background-color: var(--button-bg);
            border-color: var(--button-hover-bg);
            font-weight: bold;
        }
        .language-options-container { /* –î–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —è–∑—ã–∫–æ–≤ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö */
            max-height: 250px;
            overflow-y: auto;
            padding-right: 10px;
        }
        .language-options-container::-webkit-scrollbar {
            width: 8px;
        }
        .language-options-container::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 10px;
        }
        .language-options-container::-webkit-scrollbar-thumb {
            background: var(--button-bg);
            border-radius: 10px;
        }
        .language-options-container::-webkit-scrollbar-thumb:hover {
            background: var(--button-hover-bg);
        }
    </style>
</head>
<body>

    <div id="mainMenuScreen" class="screen active">
        <h1>–ö—Ä–µ—Å—Ç–∏–∫–∏-–ù–æ–ª–∏–∫–∏ Deluxe</h1>
        <button class="menu-button" id="playButton" onclick="showScreen('gameScreen');">–ò–≥—Ä–∞—Ç—å</button>
        <button class="menu-button" id="historyButton" onclick="showScreen('historyScreen'); loadHistory();">–ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä</button>
        <button class="menu-button" id="themesButton" onclick="showScreen('themesScreen')">–¢–µ–º—ã</button>
        <button class="menu-button" id="settingsButton" onclick="showScreen('settingsScreen')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        <div id="versionInfo">
            <p><span id="versionText">Version: 1</span></p>
            <p><span id="gameByText">Game by </span>Luckymodd</p>
        </div>
    </div>

    <div id="gameScreen" class="screen">
        <h2 id="gameTitle">–ö—Ä–µ—Å—Ç–∏–∫–∏-–ù–æ–ª–∏–∫–∏</h2>
        <div class="status" id="status">–•–æ–¥ –∏–≥—Ä–æ–∫–∞ X</div>
        <div class="board" id="board">
            </div>
        <button id="resetButtonGame">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
        <button class="back-button" id="backToMenuGame" onclick="showScreen('mainMenuScreen', true)">–í –º–µ–Ω—é</button>
    </div>

    <div id="historyScreen" class="screen">
        <h2 id="historyTitle">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–±–µ–¥</h2>
        <ul id="historyList">
            </ul>
        <div style="display: flex; gap: 10px;">
            <button class="action-button" id="clearHistoryButton" style="width: auto;">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
            <button class="back-button" id="backToMenuHistory" onclick="showScreen('mainMenuScreen')" style="width: auto;">–í –º–µ–Ω—é</button>
        </div>
    </div>

    <div id="settingsScreen" class="screen">
        <h2 id="settingsTitle">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        
        <h3><span id="languageSettingsTitle">–Ø–∑—ã–∫:</span> <span id="currentLanguageDisplay">–†—É—Å—Å–∫–∏–π</span></h3>
        <div class="language-options-container" id="languageOptionsContainer">
            </div>

        <button class="menu-button" id="supportButton" style="width: auto; padding: 15px 40px; margin-top: 20px;">–ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</button>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="action-button" id="applySettingsButton" style="width: auto;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <button class="back-button" id="backToMenuSettings" onclick="confirmCancelSettings()">–í –º–µ–Ω—é</button>
        </div>
    </div>

    <div id="themesScreen" class="screen">
        <h2 id="themesTitle">–í—ã–±–æ—Ä –¢–µ–º—ã</h2>
        <div class="themes-container">
            <div id="eventThemes" class="themes-category event-themes">
                <h3 id="eventThemesTitle">–≠–≤–µ–Ω—Ç–Ω—ã–µ</h3>
                <div class="themes-grid">
                    </div>
            </div>
            <div id="ordinaryThemes" class="themes-category">
                <h3 id="ordinaryThemesTitle">–û–±—ã—á–Ω—ã–µ</h3>
                <div class="themes-grid">
                    </div>
            </div>

            <div id="specialThemes" class="themes-category">
                <h3 id="specialThemesTitle">–û—Å–æ–±—ã–µ</h3>
                <div class="themes-grid">
                    </div>
            </div>
        </div>
        <button class="back-button" id="backToMenuThemes" onclick="showScreen('mainMenuScreen')">–í –º–µ–Ω—é</button>
    </div>

    <div id="languageModal" class="modal">
        <div class="modal-content">
            <h3 id="languageModalTitle"></h3>
            <div class="language-options-container" id="firstTimeLanguageOptions">
                </div>
        </div>
    </div>

    <div id="clearHistoryConfirmModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('clearHistoryConfirmModal')">&times;</span>
            <h3 id="clearHistoryConfirmTitle">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?</h3>
            <div class="modal-buttons">
                <button class="menu-button" id="confirmClearHistoryButton"></button>
                <button class="back-button" onclick="closeModal('clearHistoryConfirmModal')"></button>
            </div>
        </div>
    </div>

    <div id="cancelSettingsConfirmModal" class="modal">
        <div class="modal-content">
            <h3 id="cancelSettingsConfirmTitle"></h3>
            <div class="modal-buttons">
                <button class="menu-button" id="cancelSettingsStayButton"></button>
                <button class="back-button" id="cancelSettingsDiscardButton"></button>
            </div>
        </div>
    </div>


    <script>
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const screens = document.querySelectorAll('.screen');
        const boardElement = document.getElementById('board');
        const statusDisplay = document.getElementById('status');
        const resetButtonGame = document.getElementById('resetButtonGame');
        const historyListElement = document.getElementById('historyList');
        const ordinaryThemesGridElement = document.querySelector('#ordinaryThemes .themes-grid');
        const specialThemesGridElement = document.querySelector('#specialThemes .themes-grid');
        const eventThemesGridElement = document.querySelector('#eventThemes .themes-grid');
        const root = document.documentElement;

        const languageModal = document.getElementById('languageModal');
        const languageModalTitle = document.getElementById('languageModalTitle');
        const firstTimeLanguageOptions = document.getElementById('firstTimeLanguageOptions');

        const settingsLanguageOptionsContainer = document.getElementById('languageOptionsContainer');
        const currentLanguageDisplay = document.getElementById('currentLanguageDisplay');
        const applySettingsButton = document.getElementById('applySettingsButton');
        const supportButton = document.getElementById('supportButton');

        const clearHistoryButton = document.getElementById('clearHistoryButton');
        const clearHistoryConfirmModal = document.getElementById('clearHistoryConfirmModal');
        const confirmClearHistoryButton = document.getElementById('confirmClearHistoryButton');

        const cancelSettingsConfirmModal = document.getElementById('cancelSettingsConfirmModal');
        const cancelSettingsStayButton = document.getElementById('cancelSettingsStayButton');
        const cancelSettingsDiscardButton = document.getElementById('cancelSettingsDiscardButton');


        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let currentPlayer = 'X';
        let gameActive = true;
        let gameState = ["", "", "", "", "", "", "", "", ""];
        let gameStartTime;
        let gameHistory = JSON.parse(localStorage.getItem('ticTacToeHistory')) || [];

        const winningConditions = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8],
            [0, 3, 6], [1, 4, 7], [2, 5, 8],
            [0, 4, 8], [2, 4, 6]
        ];

        // --- –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è ---
        const translations = {
            'ru': {
                'play': '–ò–≥—Ä–∞—Ç—å',
                'history': '–ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä',
                'themes': '–¢–µ–º—ã',
                'settings': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
                'game_title': '–ö—Ä–µ—Å—Ç–∏–∫–∏-–ù–æ–ª–∏–∫–∏',
                'turn_x': '–•–æ–¥ –∏–≥—Ä–æ–∫–∞ X',
                'turn_o': '–•–æ–¥ –∏–≥—Ä–æ–∫–∞ O',
                'player_x_wins': '–ò–≥—Ä–æ–∫ X –ø–æ–±–µ–¥–∏–ª –∑–∞',
                'player_o_wins': '–ò–≥—Ä–æ–∫ O –ø–æ–±–µ–¥–∏–ª –∑–∞',
                'draw': '–ù–∏—á—å—è –∑–∞',
                'seconds': '—Å–µ–∫!',
                'start_new': '–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ',
                'back_to_menu': '–í –º–µ–Ω—é',
                'history_title': '–ò—Å—Ç–æ—Ä–∏—è –ø–æ–±–µ–¥',
                'history_empty': '–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞ –ø—É—Å—Ç–∞. –°—ã–≥—Ä–∞–π—Ç–µ –ø–∞—Ä—Ç–∏—é!',
                'clear_history': '–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é',
                'confirm_clear_history': '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?',
                'yes_clear': '–î–∞, –æ—á–∏—Å—Ç–∏—Ç—å',
                'cancel': '–û—Ç–º–µ–Ω–∞',
                'themes_title': '–í—ã–±–æ—Ä –¢–µ–º—ã',
                'event_themes': '–≠–≤–µ–Ω—Ç–Ω—ã–µ',
                'ordinary_themes': '–û–±—ã—á–Ω—ã–µ',
                'special_themes': '–û—Å–æ–±—ã–µ',
                'settings_title': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
                'select_your_language': '–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–π —è–∑—ã–∫',
                'language': '–Ø–∑—ã–∫:',
                'write_to_support': '–ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É',
                'apply': '–ü—Ä–∏–º–µ–Ω–∏—Ç—å',
                'confirm_cancel_settings': '–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è?',
                'discard': '–û—Ç–º–µ–Ω–∏—Ç—å',
                'game_by': '–ò–≥—Ä–∞ –æ—Ç',
                'theme_default': '–ü–æ –£–º–æ–ª—á–∞–Ω–∏—é',
                'theme_forest': '–õ–µ—Å',
                'theme_ocean': '–û–∫–µ–∞–Ω',
                'theme_lava': '–õ–∞–≤–∞',
                'theme_excellent_poor': '–û—Ç–ª–∏—á–Ω–∏–∫ vs –î–≤–æ–µ—á–Ω–∏–∫',
                'theme_stars_moon': '–ó–≤–µ–∑–¥—ã –∏ –õ—É–Ω–∞',
                'theme_stars_moon_emoji': '–ó–≤–µ–∑–¥—ã –∏ –õ—É–Ω–∞ (–≠–º–æ–¥–∑–∏)',
                'theme_boring_lessons': '–°–∫—É—á–Ω—ã–µ –£—Ä–æ–∫–∏',
                'theme_water_vs_lava': '–í–æ–¥–∞ vs –õ–∞–≤–∞',
                'theme_summer_emoji': '–õ–µ—Ç–æ –≤ —ç–º–æ–¥–∑–∏'
            },
            'en': {
                'play': 'Play',
                'history': 'Game History',
                'themes': 'Themes',
                'settings': 'Settings',
                'game_title': 'Tic-Tac-Toe',
                'turn_x': 'X\'s Turn',
                'turn_o': 'O\'s Turn',
                'player_x_wins': 'Player X won in',
                'player_o_wins': 'Player O won in',
                'draw': 'Draw in',
                'seconds': 'sec!',
                'start_new': 'Start New Game',
                'back_to_menu': 'Back to Menu',
                'history_title': 'Win History',
                'history_empty': 'History is empty. Play a game!',
                'clear_history': 'Clear History',
                'confirm_clear_history': 'Are you sure you want to clear history?',
                'yes_clear': 'Yes, clear',
                'cancel': 'Cancel',
                'themes_title': 'Choose Theme',
                'event_themes': 'Event Themes',
                'ordinary_themes': 'Ordinary',
                'special_themes': 'Special',
                'settings_title': 'Settings',
                'select_your_language': 'Select your language',
                'language': 'Language:',
                'write_to_support': 'Write to support',
                'apply': 'Apply',
                'confirm_cancel_settings': 'Do you really want to discard unsaved changes?',
                'discard': 'Discard',
                'game_by': 'Game by',
                'theme_default': 'Default',
                'theme_forest': 'Forest',
                'theme_ocean': 'Ocean',
                'theme_lava': 'Lava',
                'theme_excellent_poor': 'A-Student vs F-Student',
                'theme_stars_moon': 'Stars and Moon',
                'theme_stars_moon_emoji': 'Stars and Moon (Emoji)',
                'theme_boring_lessons': 'Boring Lessons',
                'theme_water_vs_lava': 'Water vs Lava',
                'theme_summer_emoji': 'Summer in Emoji'
            },
            'es': {
                'play': 'Jugar',
                'history': 'Historial de Juegos',
                'themes': 'Temas',
                'settings': 'Configuraci√≥n',
                'game_title': 'Tres en Raya',
                'turn_x': 'Turno de X',
                'turn_o': 'Turno de O',
                'player_x_wins': 'El jugador X gan√≥ en',
                'player_o_wins': 'El jugador O gan√≥ en',
                'draw': 'Empate en',
                'seconds': 'seg!',
                'start_new': 'Empezar de Nuevo',
                'back_to_menu': 'Volver al Men√∫',
                'history_title': 'Historial de Victorias',
                'history_empty': 'Historial vac√≠o. ¬°Juega una partida!',
                'clear_history': 'Borrar Historial',
                'confirm_clear_history': '¬øSeguro que quieres borrar el historial?',
                'yes_clear': 'S√≠, borrar',
                'cancel': 'Cancelar',
                'themes_title': 'Elegir Tema',
                'event_themes': 'Temas de Evento',
                'ordinary_themes': 'Ordinarios',
                'special_themes': 'Especiales',
                'settings_title': 'Configuraci√≥n',
                'select_your_language': 'Selecciona tu idioma',
                'language': 'Idioma:',
                'write_to_support': 'Escribir a soporte',
                'apply': 'Aplicar',
                'confirm_cancel_settings': '¬øRealmente quieres descartar los cambios no guardados?',
                'discard': 'Descartar',
                'game_by': 'Juego por',
                'theme_default': 'Por Defecto',
                'theme_forest': 'Bosque',
                'theme_ocean': 'Oc√©ano',
                'theme_lava': 'Lava',
                'theme_excellent_poor': 'Estudiante A vs Estudiante F',
                'theme_stars_moon': 'Estrellas y Luna',
                'theme_stars_moon_emoji': 'Estrellas y Luna (Emoji)',
                'theme_boring_lessons': 'Clases Aburridas',
                'theme_water_vs_lava': 'Agua vs Lava',
                'theme_summer_emoji': 'Verano en Emoji'
            },
            'pt': {
                'play': 'Jogar',
                'history': 'Hist√≥rico de Jogos',
                'themes': 'Temas',
                'settings': 'Configura√ß√µes',
                'game_title': 'Jogo da Velha',
                'turn_x': 'Vez de X',
                'turn_o': 'Vez de O',
                'player_x_wins': 'Jogador X venceu em',
                'player_o_wins': 'Jogador O venceu em',
                'draw': 'Empate em',
                'seconds': 'seg!',
                'start_new': 'Come√ßar Novo Jogo',
                'back_to_menu': 'Voltar ao Menu',
                'history_title': 'Hist√≥rico de Vit√≥rias',
                'history_empty': 'Hist√≥rico vazio. Jogue uma partida!',
                'clear_history': 'Limpar Hist√≥rico',
                'confirm_clear_history': 'Tem certeza de que deseja limpar o hist√≥rico?',
                'yes_clear': 'Sim, limpar',
                'cancel': 'Cancelar',
                'themes_title': 'Escolher Tema',
                'event_themes': 'Temas de Evento',
                'ordinary_themes': 'Ordin√°rios',
                'special_themes': 'Especiais',
                'settings_title': 'Configura√ß√µes',
                'select_your_language': 'Selecione seu idioma',
                'language': 'Idioma:',
                'write_to_support': 'Escrever para suporte',
                'apply': 'Aplicar',
                'confirm_cancel_settings': 'Deseja realmente descartar as altera√ß√µes n√£o salvas?',
                'discard': 'Descartar',
                'game_by': 'Jogo por',
                'theme_default': 'Padr√£o',
                'theme_forest': 'Floresta',
                'theme_ocean': 'Oceano',
                'theme_lava': 'Lava',
                'theme_excellent_poor': 'Aluno A vs Aluno F',
                'theme_stars_moon': 'Estrelas e Lua',
                'theme_stars_moon_emoji': 'Estrelas e Lua (Emoji)',
                'theme_boring_lessons': 'Aulas Chatas',
                'theme_water_vs_lava': '√Ågua vs Lava',
                'theme_summer_emoji': 'Ver√£o em Emoji'
            },
            'it': {
                'play': 'Gioca',
                'history': 'Cronologia Partite',
                'themes': 'Temi',
                'settings': 'Impostazioni',
                'game_title': 'Tris',
                'turn_x': 'Turno di X',
                'turn_o': 'Turno di O',
                'player_x_wins': 'Giocatore X ha vinto in',
                'player_o_wins': 'Giocatore O ha vinto in',
                'draw': 'Pareggio in',
                'seconds': 'sec!',
                'start_new': 'Inizia Nuova Partita',
                'back_to_menu': 'Torna al Menu',
                'history_title': 'Cronologia Vittorie',
                'history_empty': 'Cronologia vuota. Gioca una partita!',
                'clear_history': 'Cancella Cronologia',
                'confirm_clear_history': 'Sei sicuro di voler cancellare la cronologia?',
                'yes_clear': 'S√¨, cancella',
                'cancel': 'Annulla',
                'themes_title': 'Scegli Tema',
                'event_themes': 'Temi Evento',
                'ordinary_themes': 'Ordinari',
                'special_themes': 'Speciali',
                'settings_title': 'Impostazioni',
                'select_your_language': 'Seleziona la tua lingua',
                'language': 'Lingua:',
                'write_to_support': 'Scrivi al supporto',
                'apply': 'Applica',
                'confirm_cancel_settings': 'Vuoi davvero scartare le modifiche non salvate?',
                'discard': 'Scarta',
                'game_by': 'Gioco di',
                'theme_default': 'Predefinito',
                'theme_forest': 'Foresta',
                'theme_ocean': 'Oceano',
                'theme_lava': 'Lava',
                'theme_excellent_poor': 'Studente A vs Studente F',
                'theme_stars_moon': 'Stelle e Luna',
                'theme_stars_moon_emoji': 'Stelle e Luna (Emoji)',
                'theme_boring_lessons': 'Lezioni noiose',
                'theme_water_vs_lava': 'Acqua vs Lava',
                'theme_summer_emoji': 'Estate in Emoji'
            }
        };

        const languageNames = {
            'ru': '–†—É—Å—Å–∫–∏–π',
            'en': 'English',
            'es': 'Espa√±ol',
            'pt': 'Portugu√™s',
            'it': 'Italiano'
        };

        let currentLanguage = localStorage.getItem('ticTacToeLanguage') || 'en';
        let tempSettingsLanguage = currentLanguage;

         // --- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¢–µ–º ---
         const themes = {
             'summer-emoji': {
                 nameKey: 'theme_summer_emoji', // –ö–ª—é—á –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
                 category: 'event',
                 vars: {
                    '--main-bg': '#add8e6',
                    '--container-bg': '#87ceeb',
                    '--button-bg': 'linear-gradient(90deg, #4682b4, #ffd700)',
                    '--button-hover-bg': 'linear-gradient(90deg, #5b9bd5, #ffe400)',
                    '--x-color': '#0056b3',
                    '--o-color': '#ffbe0b',
                    '--text-color': '#333333',
                    '--border-color': '#60a5fa',
                    '--shadow-color': 'rgba(0, 0, 0, 0.3)',
                    '--body-bg-start': '#87ceeb',
                    '--body-bg-end': '#ffd700',
                    '--body-bg-direction': '45deg',
                    '--body-bg-size': '200% 200%',
                    '--body-bg-animation': 'gradientShift 15s ease infinite alternate',
                 },
                 marks: { x: 'üåßÔ∏è', o: '‚òÄÔ∏è' },
                 preview: { '--preview-x-color': '#0056b3', '--preview-o-color': '#ffbe0b' }
             },
             'default': {
                 nameKey: 'theme_default',
                 category: 'ordinary',
                 vars: {
                    '--main-bg': '#1f2937',
                    '--container-bg': '#374151',
                    '--button-bg': '#4f46e5',
                    '--button-hover-bg': '#6366f1',
                    '--x-color': '#ef4444',
                    '--o-color': '#3b82f6',
                    '--text-color': '#f3f4f6',
                    '--border-color': '#6b7280',
                    '--shadow-color': 'rgba(0, 0, 0, 0.6)',
                    '--body-bg-start': '#111827',
                    '--body-bg-end': '#1f2937',
                    '--body-bg-direction': '135deg',
                    '--body-bg-size': 'auto',
                    '--body-bg-animation': 'none',
                 },
                 marks: { x: 'X', o: 'O' },
                 preview: { '--preview-x-color': '#ef4444', '--preview-o-color': '#3b82f6' }
             },
             'forest': {
                 nameKey: 'theme_forest',
                 category: 'ordinary',
                 vars: {
                    '--main-bg': '#1e3a24',
                    '--container-bg': '#224d2b',
                    '--button-bg': '#346c41',
                    '--button-hover-bg': '#4a805a',
                    '--x-color': '#facc15',
                    '--o-color': '#a7f3d0',
                    '--text-color': '#d1fae5',
                    '--border-color': '#4b5563',
                    '--shadow-color': 'rgba(0, 0, 0, 0.6)',
                    '--body-bg-start': '#064e3b',
                    '--body-bg-end': '#1e3a24',
                    '--body-bg-direction': 'top right',
                    '--body-bg-size': 'auto',
                    '--body-bg-animation': 'none',
                 },
                 marks: { x: 'X', o: 'O' },
                 preview: { '--preview-x-color': '#facc15', '--preview-o-color': '#a7f3d0' }
             },
             'ocean': {
                 nameKey: 'theme_ocean',
                 category: 'ordinary',
                 vars: {
                    '--main-bg': '#1e3a8a',
                    '--container-bg': '#1c4a7b',
                    '--button-bg': '#2563eb',
                    '--button-hover-bg': '#3b82f6',
                    '--x-color': '#f87171',
                    '--o-color': '#bfdbfe',
                    '--text-color': '#eff6ff',
                    '--border-color': '#60a5fa',
                    '--shadow-color': 'rgba(0, 0, 0, 0.6)',
                    '--body-bg-start': '#0b173b',
                    '--body-bg-end': '#1e3a8a',
                    '--body-bg-direction': 'bottom left',
                    '--body-bg-size': 'auto',
                    '--body-bg-animation': 'none',
                 },
                 marks: { x: 'X', o: 'O' },
                 preview: { '--preview-x-color': '#f87171', '--preview-o-color': '#bfdbfe' }
             },
              'lava': {
                 nameKey: 'theme_lava',
                 category: 'ordinary',
                 vars: {
                    '--main-bg': '#450a0a',
                    '--container-bg': '#7f1d1d',
                    '--button-bg': '#dc2626',
                    '--button-hover-bg': '#ef4444',
                    '--x-color': '#fef08a',
                    '--o-color': '#f97316',
                    '--text-color': '#fef2f2',
                    '--border-color': '#b91c1c',
                    '--shadow-color': 'rgba(0, 0, 0, 0.8)',
                    '--body-bg-start': '#0c0606',
                    '--body-bg-end': '#450a0a',
                    '--body-bg-direction': 'to top',
                    '--body-bg-size': '600% 600%',
                    '--body-bg-animation': 'gradientShift 30s ease infinite',
                 },
                 marks: { x: 'X', o: 'O' },
                 preview: { '--preview-x-color': '#fef08a', '--preview-o-color': '#f97316' }
             },
             'excellent-poor': {
                 nameKey: 'theme_excellent_poor',
                 category: 'special',
                 vars: {
                    '--main-bg': '#ffffff',
                    '--container-bg': '#f0f0f0',
                    '--button-bg': '#4CAF50',
                    '--button-hover-bg': '#66BB6A',
                    '--x-color': '#ef4444',
                    '--o-color': '#3b82f6',
                    '--text-color': '#333333',
                    '--border-color': '#cccccc',
                    '--shadow-color': 'rgba(0, 0, 0, 0.2)',
                    '--body-bg-start': '#ffffff',
                    '--body-bg-end': '#f0f0f0',
                    '--body-bg-direction': '135deg',
                    '--body-bg-size': 'auto',
                    '--body-bg-animation': 'none',
                 },
                 marks: { x: '2', o: '5' },
                 preview: { '--preview-x-color': '#ef4444', '--preview-o-color': '#3b82f6' }
             },
             'stars-moon': {
                 nameKey: 'theme_stars_moon',
                 category: 'special',
                 vars: {
                    '--main-bg': '#0a0a23',
                    '--container-bg': '#1a1a3b',
                    '--button-bg': '#3a245c',
                    '--button-hover-bg': '#5a3b8d',
                    '--x-color': '#ffffa0',
                    '--o-color': '#f0f0f0',
                    '--text-color': '#e0e0ff',
                    '--border-color': '#404060',
                    '--shadow-color': 'rgba(0, 0, 0, 0.8)',
                    '--body-bg-start': '#000000',
                    '--body-bg-end': '#1a1a3b',
                    '--body-bg-direction': 'to bottom right',
                    '--body-bg-size': 'auto',
                    '--body-bg-animation': 'none',
                 },
                 marks: { x: 'X', o: 'O' },
                 preview: { '--preview-x-color': '#ffffa0', '--preview-o-color': '#f0f0f0' }
             },
             'stars-moon-emoji': {
                 nameKey: 'theme_stars_moon_emoji',
                 category: 'special',
                 vars: {
                    '--main-bg': '#0a0a23',
                    '--container-bg': '#1a1a3b',
                    '--button-bg': '#3a245c',
                    '--button-hover-bg': '#5a3b8d',
                    '--x-color': '#ffffa0',
                    '--o-color': '#f0f0f0',
                    '--text-color': '#e0e0ff',
                    '--border-color': '#404060',
                    '--shadow-color': 'rgba(0, 0, 0, 0.8)',
                    '--body-bg-start': '#000000',
                    '--body-bg-end': '#1a1a3b',
                    '--body-bg-direction': 'to bottom right',
                    '--body-bg-size': 'auto',
                    '--body-bg-animation': 'none',
                 },
                 marks: { x: '‚≠ê', o: 'üåï' },
                 preview: { '--preview-x-color': '#ffffa0', '--preview-o-color': '#f0f0f0' }
             },
             'boring-lessons': {
                 nameKey: 'theme_boring_lessons',
                 category: 'ordinary',
                 vars: {
                    '--main-bg': '#ffffff',
                    '--container-bg': '#f0f0f0',
                    '--button-bg': '#6b7280',
                    '--button-hover-bg': '#9ca3af',
                    '--x-color': 'black',
                    '--o-color': 'black',
                    '--text-color': '#333333',
                    '--border-color': '#cccccc',
                    '--shadow-color': 'rgba(0, 0, 0, 0.2)',
                    '--body-bg-start': '#ffffff',
                    '--body-bg-end': '#f0f0f0',
                    '--body-bg-direction': '135deg',
                    '--body-bg-size': 'auto',
                    '--body-bg-animation': 'none',
                 },
                 marks: { x: 'X', o: 'O' },
                 preview: { '--preview-x-color': 'black', '--preview-o-color': 'black' }
             },
             'water-vs-lava': {
                 nameKey: 'theme_water_vs_lava',
                 category: 'ordinary',
                 vars: {
                    '--main-bg': '#ff4500',
                    '--container-bg': '#4169e1',
                    '--button-bg': 'linear-gradient(90deg, #ff4500, #4169e1)',
                    '--button-hover-bg': 'linear-gradient(90deg, #ff6347, #6a5acd)',
                    '--x-color': '#ff4500',
                    '--o-color': '#4169e1',
                    '--text-color': '#f3f4f6',
                    '--border-color': '#808080',
                    '--shadow-color': 'rgba(0, 0, 0, 0.6)',
                    '--body-bg-start': '#ff4500',
                    '--body-bg-end': '#4169e1',
                    '--body-bg-direction': '45deg',
                    '--body-bg-size': '200% 200%',
                    '--body-bg-animation': 'gradientShift 20s ease infinite alternate',
                 },
                 marks: { x: 'X', o: 'O' },
                 preview: { '--preview-x-color': '#ff4500', '--preview-o-color': '#4169e1' }
             }
         };

        let currentThemeKey = localStorage.getItem('ticTacToeTheme') || 'default';


        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞–º–∏ ---
        // –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä resetGame –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞ –∏–≥—Ä—ã
        function showScreen(screenId, resetGame = false) {
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');

            // –°–±—Ä–æ—Å –∏–≥—Ä—ã –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –¥—Ä—É–≥–∏–µ —ç–∫—Ä–∞–Ω—ã
            if (screenId !== 'gameScreen' && document.getElementById('gameScreen').classList.contains('active')) {
                startGame(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–≥—Ä—É, –µ—Å–ª–∏ —É—Ö–æ–¥–∏–º —Å –∏–≥—Ä–æ–≤–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
            }

            // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —ç–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–µ–∫, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —è–∑—ã–∫–æ–≤
            if (screenId === 'settingsScreen') {
                populateLanguageOptions(settingsLanguageOptionsContainer, tempSettingsLanguage, (lang) => {
                    tempSettingsLanguage = lang;
                    currentLanguageDisplay.textContent = languageNames[tempSettingsLanguage];
                });
            }
            if (screenId === 'themesScreen') {
                 populateThemesGrid();
            }
            if (screenId === 'gameScreen' && resetGame) { // –ï—Å–ª–∏ —è–≤–Ω–æ –∑–∞–ø—Ä–æ—à–µ–Ω —Å–±—Ä–æ—Å –∏–≥—Ä—ã
                startGame();
            } else if (screenId === 'gameScreen') { // –ï—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞—à–ª–∏ –Ω–∞ gameScreen –±–µ–∑ —è–≤–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –∏–≥—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ –ø–æ–±–µ–¥—ã/–Ω–∏—á—å–µ–π –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏)
                // —Ç–æ –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é –∏–≥—Ä—É. –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –±–∞–≥ —Å –ø—É—Å—Ç—ã–º–∏ –ø–ª–∏—Ç–∫–∞–º–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.
                if (!gameActive || gameState.every(cell => cell === "")) {
                     startGame();
                }
            }
            updateTextContent(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø—Ä–∏ —Å–º–µ–Ω–µ —ç–∫—Ä–∞–Ω–∞
        }

        // --- –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã ---
        function startGame() {
            boardElement.innerHTML = ''; // –û—á–∏—â–∞–µ–º –¥–æ—Å–∫—É
            gameState = ["", "", "", "", "", "", "", "", ""];
            currentPlayer = 'X';
            gameActive = true;
            statusDisplay.textContent = `${translations[currentLanguage].turn_x}`;
            statusDisplay.style.color = root.style.getPropertyValue(currentPlayer === 'X' ? '--x-color' : '--o-color');

            gameStartTime = new Date();

            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                cell.dataset.index = i;
                cell.dataset.cellNumber = i + 1; // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä —è—á–µ–π–∫–∏
                cell.addEventListener('click', handleCellClick);

                const playerMarkSpan = document.createElement('span');
                playerMarkSpan.classList.add('player-mark');
                // playerMarkSpan.textContent –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ handleCellClick

                const cellNumberSpan = document.createElement('span');
                cellNumberSpan.classList.add('cell-number');
                cellNumberSpan.textContent = i + 1; // –ù–æ–º–µ—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                
                cell.appendChild(playerMarkSpan);
                cell.appendChild(cellNumberSpan); // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä –≤ —è—á–µ–π–∫—É
                
                boardElement.appendChild(cell);
            }
            // –ü–µ—Ä–µ–ø—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É, —á—Ç–æ–±—ã —Å–∏–º–≤–æ–ª—ã –±—ã–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏
            applyTheme(currentThemeKey);
        }

        function handleCellClick(event) {
            const clickedCell = event.target.closest('.cell'); // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∫–ª–∏–∫ –±—ã–ª –ø–æ —è—á–µ–π–∫–µ
            if (!clickedCell) return;

            const clickedCellIndex = parseInt(clickedCell.dataset.index);

            if (gameState[clickedCellIndex] !== "" || !gameActive) {
                return;
            }

            makeMove(clickedCellIndex);
        }

        function makeMove(index) {
            if (gameState[index] !== "" || !gameActive) {
                return;
            }

            gameState[index] = currentPlayer;

            const currentTheme = themes[currentThemeKey];
            const markToShow = currentPlayer === 'X' ? currentTheme.marks.x : currentTheme.marks.o;

            const cellElement = boardElement.children[index];
            const playerMarkSpan = cellElement.querySelector('.player-mark');
            const cellNumberSpan = cellElement.querySelector('.cell-number');

            playerMarkSpan.textContent = markToShow;
            cellElement.classList.add(currentPlayer.toLowerCase());
            if (currentThemeKey === 'boring-lessons') {
                cellElement.classList.add('boring-lessons');
            }
            // –°–∫—Ä—ã—Ç—å –Ω–æ–º–µ—Ä –ø–æ—Å–ª–µ —Ö–æ–¥–∞
            if (cellNumberSpan) {
                cellNumberSpan.style.opacity = '0';
            }


            checkResult();
        }

        function checkResult() {
            let roundWon = false;
            for (let i = 0; i < winningConditions.length; i++) {
                const winCondition = winningConditions[i];
                let a = gameState[winCondition[0]];
                let b = gameState[winCondition[1]];
                let c = gameState[winCondition[2]];
                if (a === '' || b === '' || c === '') continue;
                if (a === b && b === c) {
                    roundWon = true;
                    break;
                }
            }

            const gameEndTime = new Date();
            const gameDuration = Math.round((gameEndTime - gameStartTime) / 1000);

            if (roundWon) {
                const playerWonText = currentPlayer === 'X' ? translations[currentLanguage].player_x_wins : translations[currentLanguage].player_o_wins;
                statusDisplay.textContent = `${playerWonText} ${gameDuration} ${translations[currentLanguage].seconds}`;
                statusDisplay.style.color = root.style.getPropertyValue(currentPlayer === 'X' ? '--x-color' : '--o-color');
                addHistoryRecord(`${translations[currentLanguage]['player_' + currentPlayer.toLowerCase() + '_wins'].split(' ')[0]} ${currentPlayer}`, gameDuration);
                gameActive = false;
                return;
            }

            if (!gameState.includes("")) {
                statusDisplay.textContent = `${translations[currentLanguage].draw} ${gameDuration} ${translations[currentLanguage].seconds}`;
                statusDisplay.style.color = root.style.getPropertyValue('--text-color');
                addHistoryRecord(translations[currentLanguage].draw, gameDuration);
                gameActive = false;
                return;
            }

            currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
            statusDisplay.textContent = `${translations[currentLanguage]['turn_' + currentPlayer.toLowerCase()]}`;
            statusDisplay.style.color = root.style.getPropertyValue(currentPlayer === 'X' ? '--x-color' : '--o-color');
        }

        resetButtonGame.addEventListener('click', startGame);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –∫–ª–∞–≤–∏—à –¥–ª—è –∏–≥—Ä—ã
        document.addEventListener('keydown', (event) => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∞–∫—Ç–∏–≤–µ–Ω —ç–∫—Ä–∞–Ω –∏–≥—Ä—ã
            if (document.getElementById('gameScreen').classList.contains('active')) {
                const keyPressed = parseInt(event.key);
                if (keyPressed >= 1 && keyPressed <= 9) {
                    const index = keyPressed - 1; // –ù–æ–º–µ—Ä —è—á–µ–π–∫–∏ 1-9 —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω–¥–µ–∫—Å—É 0-8
                    makeMove(index);
                }
            }
        });


        // --- –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä ---
        function addHistoryRecord(winner, duration) {
            const record = {
                winner: winner,
                duration: duration,
                date: new Date().toLocaleString(currentLanguage === 'ru' ? 'ru-RU' : `${currentLanguage}-${currentLanguage.toUpperCase()}`)
            };
            gameHistory.unshift(record);
            if (gameHistory.length > 20) {
                gameHistory.pop();
            }
            localStorage.setItem('ticTacToeHistory', JSON.stringify(gameHistory));
        }

        function loadHistory() {
            historyListElement.innerHTML = '';
            if (gameHistory.length === 0) {
                historyListElement.innerHTML = `<li>${translations[currentLanguage].history_empty}</li>`;
                return;
            }
            gameHistory.forEach(record => {
                const listItem = document.createElement('li');
                listItem.textContent = `${record.date} - ${record.winner}, ${translations[currentLanguage].seconds.replace('!', '')}: ${record.duration} ${translations[currentLanguage].seconds.split(' ')[0]}.`;
                historyListElement.appendChild(listItem);
            });
        }

        // –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
        clearHistoryButton.addEventListener('click', () => {
            openModal('clearHistoryConfirmModal');
        });

        confirmClearHistoryButton.addEventListener('click', () => {
            gameHistory = [];
            localStorage.removeItem('ticTacToeHistory');
            loadHistory();
            closeModal('clearHistoryConfirmModal');
        });

        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¢–µ–º–∞–º–∏ ---
        function applyTheme(themeKey) {
            const theme = themes[themeKey];
            if (!theme) {
                console.error('–¢–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', themeKey);
                return;
            }

            for (const [prop, value] of Object.entries(theme.vars)) {
                root.style.setProperty(prop, value);
            }

            localStorage.setItem('ticTacToeTheme', themeKey);
            currentThemeKey = themeKey;

            updateThemesUI(); // –û–±–Ω–æ–≤–ª—è–µ–º UI —Ç–µ–º

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏–º–≤–æ–ª—ã –Ω–∞ –¥–æ—Å–∫–µ, –µ—Å–ª–∏ –∏–≥—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞ –∏–ª–∏ –ø–æ–ª–µ –Ω–µ –ø—É—Å—Ç–æ–µ
            const cells = boardElement.children;
            for (let i = 0; i < cells.length; i++) {
                const cell = cells[i];
                const playerMarkSpan = cell.querySelector('.player-mark');
                const cellNumberSpan = cell.querySelector('.cell-number');

                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–ª–∞—Å—Å—ã —Ç–µ–º
                cell.classList.remove('x', 'o', 'boring-lessons');

                if (gameState[i] !== "") {
                    const player = gameState[i];
                    const markToShow = player === 'X' ? theme.marks.x : theme.marks.o;
                    playerMarkSpan.textContent = markToShow;
                    cell.classList.add(player.toLowerCase());
                    if (currentThemeKey === 'boring-lessons') {
                         cell.classList.add('boring-lessons');
                     }
                    // –°–∫—Ä—ã–≤–∞–µ–º –Ω–æ–º–µ—Ä, –µ—Å–ª–∏ —Å–∏–º–≤–æ–ª —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                    if (cellNumberSpan) {
                        cellNumberSpan.style.opacity = '0';
                    }
                } else {
                    // –ï—Å–ª–∏ —è—á–µ–π–∫–∞ –ø—É—Å—Ç–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–º–µ—Ä –∏ –æ—á–∏—â–∞–µ–º —Å–∏–º–≤–æ–ª
                    playerMarkSpan.textContent = '';
                    if (cellNumberSpan) {
                        cellNumberSpan.style.opacity = '1';
                    }
                }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç —Å—Ç–∞—Ç—É—Å–∞, –µ—Å–ª–∏ –∏–≥—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞ –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
            if (document.getElementById('gameScreen').classList.contains('active')) {
                 if (gameActive) {
                     statusDisplay.style.color = root.style.getPropertyValue(currentPlayer === 'X' ? '--x-color' : '--o-color');
                 } else { // –ï—Å–ª–∏ –∏–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (–ø–æ–±–µ–¥–∞/–Ω–∏—á—å—è)
                    const statusText = statusDisplay.textContent;
                    if (statusText.includes(translations[currentLanguage].player_x_wins.split(' ')[0])) {
                        statusDisplay.style.color = root.style.getPropertyValue('--x-color');
                    } else if (statusText.includes(translations[currentLanguage].player_o_wins.split(' ')[0])) {
                        statusDisplay.style.color = root.style.getPropertyValue('--o-color');
                    } else if (statusText.includes(translations[currentLanguage].draw.split(' ')[0])) {
                        statusDisplay.style.color = root.style.getPropertyValue('--text-color');
                    }
                 }
             }
        }

        function populateThemesGrid() {
             eventThemesGridElement.innerHTML = '';
             ordinaryThemesGridElement.innerHTML = '';
             specialThemesGridElement.innerHTML = '';

             for (const themeKey in themes) {
                 const theme = themes[themeKey];
                 const optionDiv = document.createElement('div');
                 optionDiv.classList.add('theme-option');
                 optionDiv.dataset.themeKey = themeKey;

                 if (themeKey === currentThemeKey) {
                     optionDiv.classList.add('selected');
                     if (theme.category === 'event') {
                         optionDiv.classList.add('event-theme');
                     }
                 }

                 const previewDiv = document.createElement('div');
                 previewDiv.classList.add('theme-preview');
                 if (themeKey === 'boring-lessons') {
                     previewDiv.classList.add('boring-lessons');
                 }

                 previewDiv.style.setProperty('--preview-x-color', theme.preview['--preview-x-color']);
                 previewDiv.style.setProperty('--preview-o-color', theme.preview['--preview-o-color']);

                 const previewX = document.createElement('span');
                 previewX.classList.add('preview-x');
                 previewX.textContent = theme.marks.x;

                 const previewO = document.createElement('span');
                 previewO.classList.add('preview-o');
                 previewO.textContent = theme.marks.o;

                 previewDiv.appendChild(previewX);
                 previewDiv.appendChild(previewO);


                 const nameSpan = document.createElement('span');
                 // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–µ–º—ã
                 nameSpan.textContent = translations[currentLanguage][theme.nameKey] || theme.nameKey;

                 optionDiv.appendChild(previewDiv);
                 optionDiv.appendChild(nameSpan);

                 optionDiv.addEventListener('click', () => {
                     applyTheme(themeKey);
                 });

                 if (theme.category === 'event') {
                     eventThemesGridElement.appendChild(optionDiv);
                 } else if (theme.category === 'ordinary') {
                     ordinaryThemesGridElement.appendChild(optionDiv);
                 } else if (theme.category === 'special') {
                     specialThemesGridElement.appendChild(optionDiv);
                 }
             }
        }

        function updateThemesUI() {
             const options = document.querySelectorAll('.theme-option');
             options.forEach(option => {
                 option.classList.remove('selected', 'event-theme');
                 if (option.dataset.themeKey === currentThemeKey) {
                     option.classList.add('selected');
                     if (themes[currentThemeKey].category === 'event') {
                         option.classList.add('event-theme');
                     }
                 }
                 // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å –≤ translations
                 const themeKey = option.dataset.themeKey;
                 const theme = themes[themeKey];
                 if (theme && theme.nameKey) {
                     option.querySelector('span:last-child').textContent = translations[currentLanguage][theme.nameKey] || theme.nameKey;
                 }
             });
         }

        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞–º–∏ ---
        function applyLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('ticTacToeLanguage', lang);
            updateTextContent();
            applyTheme(currentThemeKey); // –ü–µ—Ä–µ–ø—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏–ª–∏—Å—å —Å–∏–º–≤–æ–ª—ã –Ω–∞ –¥–æ—Å–∫–µ
        }

        function updateTextContent() {
            document.getElementById('playButton').textContent = translations[currentLanguage].play;
            document.getElementById('historyButton').textContent = translations[currentLanguage].history;
            document.getElementById('themesButton').textContent = translations[currentLanguage].themes;
            document.getElementById('settingsButton').textContent = translations[currentLanguage].settings;
            document.getElementById('gameByText').textContent = translations[currentLanguage].game_by + ' ';

            document.getElementById('gameTitle').textContent = translations[currentLanguage].game_title;
            if (gameActive) {
                statusDisplay.textContent = `${translations[currentLanguage]['turn_' + currentPlayer.toLowerCase()]}`;
            } else {
                // –ï—Å–ª–∏ –∏–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å, –Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º "—Å–µ–∫—É–Ω–¥—ã" –∏ "–ø–æ–±–µ–¥–∏–ª/–Ω–∏—á—å—è"
                const lastStatus = statusDisplay.textContent;
                const durationMatch = lastStatus.match(/\d+/); // –ù–∞—Ö–æ–¥–∏–º —á–∏—Å–ª–æ (–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
                const duration = durationMatch ? parseInt(durationMatch[0]) : '';

                if (lastStatus.includes('X –ø–æ–±–µ–¥–∏–ª') || lastStatus.includes('X won')) {
                     statusDisplay.textContent = `${translations[currentLanguage].player_x_wins} ${duration} ${translations[currentLanguage].seconds}`;
                } else if (lastStatus.includes('O –ø–æ–±–µ–¥–∏–ª') || lastStatus.includes('O won')) {
                     statusDisplay.textContent = `${translations[currentLanguage].player_o_wins} ${duration} ${translations[currentLanguage].seconds}`;
                } else if (lastStatus.includes('–ù–∏—á—å—è') || lastStatus.includes('Draw')) {
                     statusDisplay.textContent = `${translations[currentLanguage].draw} ${duration} ${translations[currentLanguage].seconds}`;
                }
            }


            document.getElementById('resetButtonGame').textContent = translations[currentLanguage].start_new;
            document.getElementById('backToMenuGame').textContent = translations[currentLanguage].back_to_menu;

            document.getElementById('historyTitle').textContent = translations[currentLanguage].history_title;
            document.getElementById('clearHistoryButton').textContent = translations[currentLanguage].clear_history;
            document.getElementById('backToMenuHistory').textContent = translations[currentLanguage].back_to_menu;

            document.getElementById('themesTitle').textContent = translations[currentLanguage].themes_title;
            document.getElementById('eventThemesTitle').textContent = translations[currentLanguage].event_themes;
            document.getElementById('ordinaryThemesTitle').textContent = translations[currentLanguage].ordinary_themes;
            document.getElementById('specialThemesTitle').textContent = translations[currentLanguage].special_themes;
            document.getElementById('backToMenuThemes').textContent = translations[currentLanguage].back_to_menu;

            document.getElementById('settingsTitle').textContent = translations[currentLanguage].settings_title;
            document.getElementById('languageSettingsTitle').textContent = translations[currentLanguage].language;
            currentLanguageDisplay.textContent = languageNames[currentLanguage];
            document.getElementById('supportButton').textContent = translations[currentLanguage].write_to_support;
            document.getElementById('applySettingsButton').textContent = translations[currentLanguage].apply;
            document.getElementById('backToMenuSettings').textContent = translations[currentLanguage].back_to_menu;

            // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
            languageModalTitle.textContent = translations[currentLanguage].select_your_language;

            document.getElementById('clearHistoryConfirmTitle').textContent = translations[currentLanguage].confirm_clear_history;
            document.getElementById('confirmClearHistoryButton').textContent = translations[currentLanguage].yes_clear;
            document.querySelector('#clearHistoryConfirmModal .back-button').textContent = translations[currentLanguage].cancel;

            document.getElementById('cancelSettingsConfirmTitle').textContent = translations[currentLanguage].confirm_cancel_settings;
            document.getElementById('cancelSettingsStayButton').textContent = translations[currentLanguage].cancel;
            document.getElementById('cancelSettingsDiscardButton').textContent = translations[currentLanguage].discard;


            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—Ä–∏–∏, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–∫—Å—Ç —Ç–∞–º —Ç–æ–∂–µ –º–µ–Ω—è–µ—Ç—Å—è
            if (document.getElementById('historyScreen').classList.contains('active')) {
                loadHistory();
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–µ–º –≤ —Å–µ—Ç–∫–µ —Ç–µ–º
            if (document.getElementById('themesScreen').classList.contains('active')) {
                populateThemesGrid();
            }
        }


        function populateLanguageOptions(container, selectedLang, onClickHandler) {
            container.innerHTML = '';
            for (const langCode in languageNames) {
                const langOption = document.createElement('div');
                langOption.classList.add('language-option');
                if (langCode === selectedLang) {
                    langOption.classList.add('selected-lang');
                }
                langOption.dataset.lang = langCode;
                langOption.textContent = languageNames[langCode];
                langOption.addEventListener('click', () => {
                    onClickHandler(langCode);
                    Array.from(container.children).forEach(child => child.classList.remove('selected-lang'));
                    langOption.classList.add('selected-lang');
                });
                container.appendChild(langOption);
            }
        }

        // --- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
        }

        // --- –õ–æ–≥–∏–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ---
        let originalSettingsLanguage = currentLanguage;

        applySettingsButton.addEventListener('click', () => {
            applyLanguage(tempSettingsLanguage);
            originalSettingsLanguage = tempSettingsLanguage;
            showScreen('mainMenuScreen');
        });

        function confirmCancelSettings() {
            if (tempSettingsLanguage !== originalSettingsLanguage) {
                openModal('cancelSettingsConfirmModal');
            } else {
                showScreen('mainMenuScreen');
            }
        }

        cancelSettingsStayButton.addEventListener('click', () => {
            closeModal('cancelSettingsConfirmModal');
            populateLanguageOptions(settingsLanguageOptionsContainer, tempSettingsLanguage, (lang) => {
                tempSettingsLanguage = lang;
                currentLanguageDisplay.textContent = languageNames[tempSettingsLanguage];
            });
        });

        cancelSettingsDiscardButton.addEventListener('click', () => {
            closeModal('cancelSettingsConfirmModal');
            tempSettingsLanguage = originalSettingsLanguage;
            showScreen('mainMenuScreen');
            applyLanguage(originalSettingsLanguage);
        });

        supportButton.addEventListener('click', () => {
            window.location.href = 'mailto:unluckymoderator@gmail.com';
        });


        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        function init() {
            const hasChosenLanguage = localStorage.getItem('ticTacToeLanguageChosen');
            if (!hasChosenLanguage) {
                showScreen('mainMenuScreen');
                openModal('languageModal');
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞
                languageModalTitle.textContent = translations['ru'].select_your_language + ' / ' +
                                                  translations['en'].select_your_language + ' / ' +
                                                  translations['es'].select_your_language + ' / ' +
                                                  translations['pt'].select_your_language + ' / ' +
                                                  translations['it'].select_your_language;

                populateLanguageOptions(firstTimeLanguageOptions, null, (lang) => {
                    applyLanguage(lang);
                    localStorage.setItem('ticTacToeLanguageChosen', 'true');
                    closeModal('languageModal');
                    // showScreen('mainMenuScreen'); // –£–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–π
                });
            } else {
                applyLanguage(currentLanguage); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —è–∑—ã–∫
                showScreen('mainMenuScreen'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            applyTheme(localStorage.getItem('ticTacToeTheme') || 'default');
            populateThemesGrid();
        }

        // --- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker –¥–ª—è PWA ---
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', function() {
            navigator.serviceWorker.register('/service-worker.js')
              .then(registration => {
                console.log('Service Worker —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', registration);
              })
              .catch(error => {
                console.log('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker:', error);
              });
          });
        }

        // –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>