<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Крестики-Нолики Deluxe</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1f2937">

    <style>
        :root {
            --main-bg: #1f2937; /* Темно-серый */
            --container-bg: #374151; /* Средне-серый */
            --button-bg: #4f46e5; /* Ярко-фиолетовый */
            --button-hover-bg: #6366f1;
            --x-color: #ef4444; /* Ярко-красный */
            --o-color: #3b82f6; /* Ярко-синий */
            --text-color: #f3f4f6; /* Очень светло-серый */
            --border-color: #6b7280; /* Серый для линий */
            --shadow-color: rgba(0, 0, 0, 0.6);
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;

            /* Переменные для фона тела */
            --body-bg-start: #111827;
            --body-bg-end: var(--main-bg);
            --body-bg-direction: 135deg;
            --body-bg-size: auto; /* Используется для анимации */
            --body-bg-animation: none; /* Используется для анимация */
            --body-bg-image: none; /* Новая переменная для фонового изображения */

            /* Переменные для превью тем */
            --preview-x-color: var(--x-color);
            --preview-o-color: var(--o-color);
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background: var(--body-bg-image), linear-gradient(var(--body-bg-direction), var(--body-bg-start) 0%, var(--body-bg-end) 100%);
            background-size: var(--body-bg-size, auto); /* Для анимации или cover для изображений */
            background-repeat: var(--body-bg-repeat, no-repeat);
            background-position: var(--body-bg-position, center center);
            animation: var(--body-bg-animation, none); /* Для анимация */

            font-family: var(--font-family);
            color: var(--text-color);
            overflow: hidden; /* Prevent scrollbars unless necessary */
            transition: background 0.5s ease; /* Плавный переход между фонами */
        }

        /* Анимация фона (применяется, если --body-bg-animation не 'none') */
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .screen {
            display: none; /* Скрываем все экраны по умолчанию */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 90%;
            max-width: 500px; /* Увеличена ширина */
            padding: 25px;
            background-color: var(--container-bg);
            border-radius: 20px;
            box-shadow: 0 20px 40px var(--shadow-color);
            text-align: center;
            box-sizing: border-box;
            position: relative; /* Для позиционирования кнопки закрытия */
        }

        .screen.active {
            display: flex; /* Показываем активный экран */
        }

        h1, h2 {
            color: var(--text-color);
            text-shadow: 0 0 8px rgba(255,255,255,0.3);
        }
        h1 { font-size: 2.8em; margin-bottom: 30px; }
        h2 { font-size: 2em; margin-bottom: 20px; }


        .menu-button, .back-button, .action-button {
            background-color: var(--button-bg);
            color: var(--text-color);
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            margin: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
            width: 250px;
            text-align: center;
        }

        .menu-button:hover, .back-button:hover, .action-button:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-3px);
        }
        
        .menu-options {
            display: flex;
            flex-direction: column;
            gap: 15px; /* Отступ между кнопками */
            width: 100%;
            align-items: center;
        }

        /* Стили для игрового поля */
        .board {
            display: grid;
            width: 300px;
            height: 300px;
            gap: 8px;
            background-color: var(--main-bg);
            padding: 8px;
            border-radius: 12px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.4), 0 3px 8px var(--shadow-color);
            margin-bottom: 20px;
        }

        .cell {
            background-color: var(--container-bg); /* Темнее, чем фон контейнера игры */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column; /* Для размещения номера и символа */
            align-items: center;
            justify-content: center;
            font-size: 3.5em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2) inset, 0 1px 1px rgba(255,255,255,0.05);
            position: relative; /* Для позиционирования номера */
        }

        .cell:hover {
            background-color: #4b5563; /* Чуть светлее при наведении */
        }

        /* Номер на плитке */
        .cell .cell-number {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.4em; /* Меньше основного символа */
            color: rgba(255, 255, 255, 0.3); /* Полупрозрачный */
            opacity: 1;
            transition: opacity 0.2s ease;
            pointer-events: none; /* Чтобы не мешал кликам */
        }

        .cell.x .cell-number,
        .cell.o .cell-number {
            opacity: 0; /* Скрываем номер после хода */
        }

        /* Цвет и стиль символов зависят от текущей темы */
        .cell .player-mark {
            opacity: 0;
            transform: scale(0.5);
            animation: appear 0.3s ease-out forwards;
            color: inherit; /* Цвет будет наследоваться от .x или .o */
            text-shadow: 0 0 7px currentColor, 0 0 3px black;
        }

        .cell.x .player-mark { color: var(--x-color); }
        .cell.o .player-mark { color: var(--o-color); }

        @keyframes appear {
            to { opacity: 1; transform: scale(1); }
        }

        .status {
            margin-bottom: 15px;
            font-size: 1.4em;
            min-height: 1.4em;
        }

        button#resetButtonGame {
            background: linear-gradient(145deg, var(--x-color), var(--o-color));
            color: var(--text-color);
            border: none;
            border-radius: 10px;
            padding: 12px 25px;
            font-size: 1.1em;
            font-weight: bold;
            margin-top:10px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s ease;
            box-shadow: 0 4px 8px var(--shadow-color);
        }
        button#resetButtonGame:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 12px var(--shadow-color);
        }

        /* История игр */
        #historyList {
            list-style: none;
            padding: 0;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        #historyList li {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            background-color: #4b5563;
        }
        #historyList li:last-child {
            border-bottom: none;
        }
        #historyList li:nth-child(odd) {
            background-color: var(--container-bg);
        }

        /* --- Стили для экрана Тем --- */
        #themesScreen .themes-category {
            width: 100%;
            margin-bottom: 25px;
        }
        #themesScreen .themes-category h3 {
            color: var(--text-color);
            font-size: 1.6em;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 5px;
            text-align: left;
            width: 100%;
        }

        #themesScreen .themes-category.event-themes h3 {
            color: gold; /* Золотой цвет для эвентных тем */
            border-color: gold;
            text-shadow: 0 0 8px gold;
        }


        #themesScreen .themes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            width: 100%;
        }

        #themesScreen .themes-container { /* Новый контейнер для прокрутки */
            width: 100%;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
            box-sizing: border-box;
        }
        /* Стилизация полосы прокрутки (Webkit) */
        #themesScreen .themes-container::-webkit-scrollbar {
            width: 8px;
        }
        #themesScreen .themes-container::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 10px;
        }
        #themesScreen .themes-container::-webkit-scrollbar-thumb {
            background: var(--button-bg);
            border-radius: 10px;
        }
        #themesScreen .themes-container::-webkit-scrollbar-thumb:hover {
            background: var(--button-hover-bg);
        }


        #themesScreen .theme-option {
            background-color: var(--main-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1em;
            font-weight: bold;
            color: var(--text-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        #themesScreen .theme-option:hover {
            transform: translateY(-3px);
            border-color: var(--button-hover-bg);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

         #themesScreen .theme-option.selected {
            border-color: var(--button-bg);
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--button-bg), 0 0 8px var(--button-bg);
        }

        #themesScreen .theme-option.selected.event-theme { /* Стиль для выбранной эвентной темы */
            border-color: gold;
            box-shadow: 0 0 15px gold, 0 0 8px gold;
        }


        #themesScreen .theme-preview {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
            background-color: var(--container-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
        }

        #themesScreen .theme-preview .preview-x,
        #themesScreen .theme-preview .preview-o {
            position: absolute;
            font-size: 1.8em;
            font-weight: bold;
            text-shadow: 0 0 4px rgba(0,0,0,0.5);
            line-height: 1; /* Убрать лишний пробел вокруг символов */
        }
        #themesScreen .theme-preview .preview-x {
            color: var(--preview-x-color);
            top: 5px; left: 5px;
        }
        #themesScreen .theme-preview .preview-o {
            color: var(--preview-o-color);
            bottom: 5px; right: 5px;
        }
        /* Специальные стили для "скучных уроков" */
        #themesScreen .theme-preview.boring-lessons .preview-x {
             color: black;
             font-weight: normal;
             opacity: 0.8;
             transform: scaleX(0.8) rotate(-45deg);
        }
        #themesScreen .theme-preview.boring-lessons .preview-o {
             color: black;
             font-weight: normal;
             opacity: 0.8;
             transform: scale(0.9);
        }

        /* Стили для текста версии и авторства */
        #versionInfo {
            margin-top: 20px;
            font-size: 1em;
            color: rgba(255, 255, 255, 0.6); /* Прозрачно-беловатый */
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            gap: 5px; /* Отступ между строками */
        }

        /* --- Стили для модальных окон --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--container-bg);
            margin: auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px; /* Увеличена ширина */
            box-shadow: 0 10px 30px var(--shadow-color);
            text-align: center;
            position: relative;
            max-height: 80vh; /* Максимальная высота для прокрутки */
            overflow-y: auto; /* Прокрутка для контента модалки */
            box-sizing: border-box;
        }
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: var(--button-bg);
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: var(--button-hover-bg);
        }


        .modal-content h3 {
            color: var(--text-color);
            margin-bottom: 25px;
            font-size: 1.8em;
        }

        .modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 25px;
        }

        .modal-buttons .menu-button {
            width: 100%;
        }

        .close-button {
            position: absolute;
            top: 15px;
            right: 20px;
            color: var(--text-color);
            font-size: 2em;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .close-button:hover {
            color: var(--button-hover-bg);
        }

        /* Стили для выбора языка в настройках */
        .language-option {
            display: block; /* Каждая опция на новой строке */
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 8px;
            background-color: #4b5563;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            text-align: left;
        }
        .language-option:hover {
            background-color: #606b7a;
            border-color: var(--button-bg);
        }
        .language-option.selected-lang {
            background-color: var(--button-bg);
            border-color: var(--button-hover-bg);
            font-weight: bold;
        }
        .language-options-container { /* Для прокрутки языков в настройках */
            max-height: 250px;
            overflow-y: auto;
            padding-right: 10px;
        }
        .language-options-container::-webkit-scrollbar {
            width: 8px;
        }
        .language-options-container::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 10px;
        }
        .language-options-container::-webkit-scrollbar-thumb {
            background: var(--button-bg);
            border-radius: 10px;
        }
        .language-options-container::-webkit-scrollbar-thumb:hover {
            background: var(--button-hover-bg);
        }

        /* Стили для выбора размера доски */
        .board-size-selection {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 300px;
        }
        .board-size-selection button {
            background-color: var(--button-bg);
            color: var(--text-color);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.5em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; /* Не сжимать кнопки */
        }
        .board-size-selection button:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-2px);
        }
        .board-size-display {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--text-color);
            min-width: 80px; /* Чтобы не скакало при смене размера */
        }
        .custom-board-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
            width: 100%;
            max-width: 250px;
        }
        .custom-board-form input {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--main-bg);
            color: var(--text-color);
            font-size: 1.1em;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
        }
        .custom-board-form input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        .custom-board-form label {
            font-size: 1em;
            color: var(--text-color);
            margin-bottom: -5px;
        }
        .custom-board-form .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .custom-board-form .input-group span {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--text-color);
        }
        .custom-board-form button {
            margin-top: 10px;
            width: 100%;
        }

        /* Стили для уведомлений */
        .notification-modal .modal-content {
            padding: 20px;
        }
        .notification-modal h3 {
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        .notification-modal .modal-buttons {
            margin-top: 15px;
        }
        .notification-modal .modal-buttons .menu-button {
            width: 150px; /* Более компактная кнопка */
            margin: 0 auto;
        }


        /* --- Медиазапросы для адаптивности --- */
        @media screen and (max-width: 768px) {
            h1 { font-size: 2.2em; margin-bottom: 20px; }
            h2 { font-size: 1.7em; margin-bottom: 15px; }
            .screen {
                padding: 20px;
            }
            .menu-button, .back-button, .action-button {
                padding: 12px 20px;
                font-size: 1.1em;
                width: 220px;
            }
            .board {
                width: 280px;
                height: 280px;
                gap: 6px;
                padding: 6px;
            }
            .cell {
                font-size: 3em;
            }
            .status {
                font-size: 1.2em;
            }
            #themesScreen .themes-grid {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
                gap: 10px;
            }
            #themesScreen .theme-option {
                padding: 10px;
            }
            #themesScreen .theme-preview {
                width: 50px;
                height: 50px;
                font-size: 2em;
            }
            #themesScreen .theme-preview .preview-x,
            #themesScreen .theme-preview .preview-o {
                font-size: 1.5em;
            }
            .modal-content {
                padding: 20px;
            }
            .modal-content h3 {
                font-size: 1.6em;
            }
            .close-button {
                font-size: 1.8em;
                top: 10px;
                right: 15px;
            }
            .board-size-selection button {
                width: 40px;
                height: 40px;
                font-size: 1.3em;
            }
            .board-size-display {
                font-size: 1.6em;
            }
            .custom-board-form {
                max-width: 220px;
            }
            .custom-board-form input {
                font-size: 1em;
            }
        }

        @media screen and (max-width: 480px) {
            h1 { font-size: 2em; margin-bottom: 15px; }
            h2 { font-size: 1.5em; margin-bottom: 10px; }
            .screen {
                padding: 15px;
            }
            .menu-button, .back-button, .action-button {
                padding: 10px 15px;
                font-size: 1em;
                width: 180px;
            }
            .board {
                width: 250px;
                height: 250px;
                gap: 4px;
                padding: 4px;
            }
            .cell {
                font-size: 2.5em;
            }
            .status {
                font-size: 1.1em;
            }
            #themesScreen .themes-grid {
                grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
                gap: 8px;
            }
            #themesScreen .theme-option {
                padding: 8px;
            }
            #themesScreen .theme-preview {
                width: 45px;
                height: 45px;
                font-size: 1.8em;
            }
            #themesScreen .theme-preview .preview-x,
            #themesScreen .theme-preview .preview-o {
                font-size: 1.3em;
            }
            .modal-content {
                padding: 15px;
            }
            .modal-content h3 {
                font-size: 1.4em;
            }
            .close-button {
                font-size: 1.5em;
                top: 8px;
                right: 10px;
            }
             .board-size-selection {
                gap: 10px;
            }
            .board-size-selection button {
                width: 35px;
                height: 35px;
                font-size: 1.2em;
            }
            .board-size-display {
                font-size: 1.4em;
            }
            .custom-board-form {
                max-width: 180px;
            }
            .custom-board-form input {
                font-size: 0.9em;
                padding: 8px 12px;
            }
            .custom-board-form .input-group span {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>

    <div id="mainMenuScreen" class="screen active">
        <h1>Крестики-Нолики Deluxe</h1>
        <div class="menu-options">
            <button class="menu-button" id="playButton">Играть</button>
            <button class="menu-button" id="historyButton" onclick="showScreen('historyScreen'); loadHistory();">История игр</button>
            <button class="menu-button" id="themesButton" onclick="showScreen('themesScreen')">Темы</button>
            <button class="menu-button" id="settingsButton" onclick="showScreen('settingsScreen')">Настройки</button>
        </div>
        <div id="versionInfo">
            <p><span id="versionText">Version: 1</span></p>
            <p><span id="gameByText">Game by </span>Luckymodd</p>
        </div>
    </div>

    <div id="gameModeSelectionScreen" class="screen">
        <span class="close-button" onclick="confirmCancelGameCreation('gameModeSelectionScreen')">&times;</span>
        <h2 id="selectGameModeTitle">Выбери режим игры</h2>
        <div class="menu-options">
            <button class="menu-button" id="ticTacToeButton">Крестики-Нолики</button>
            <button class="menu-button" id="ticTacToeBlastButton">Tic Tac Toe Blast!</button>
        </div>
    </div>

    <div id="gamePlayModeSelectionScreen" class="screen">
        <span class="close-button" onclick="confirmCancelGameCreation('gamePlayModeSelectionScreen')">&times;</span>
        <h2 id="selectGamePlayModeTitle">На чем играть?</h2>
        <div class="menu-options">
            <button class="menu-button" id="playOnPhoneButton">На телефоне</button>
            <button class="menu-button" id="playViaWifiButton">По Wi-Fi</button>
            <button class="menu-button" id="playViaBluetoothButton">По Bluetooth</button>
        </div>
        <button class="back-button" onclick="showScreen('gameModeSelectionScreen')">Назад</button>
    </div>

    <div id="boardSizeSelectionScreen" class="screen">
        <span class="close-button" onclick="confirmCancelGameCreation('boardSizeSelectionScreen')">&times;</span>
        <h2 id="selectBoardSizeTitle">Выбери размер доски</h2>
        <div class="board-size-selection">
            <button id="prevBoardSize">&lt;</button>
            <span id="currentBoardSizeDisplay" class="board-size-display">3x3</span>
            <button id="nextBoardSize">&gt;</button>
        </div>
        <form class="custom-board-form" id="customBoardForm">
            <label for="customWidth" id="customBoardLabel">Сделать свою доску:</label>
            <div class="input-group">
                <input type="number" id="customWidth" placeholder="Ширина" min="3" max="15">
                <span>x</span>
                <input type="number" id="customHeight" placeholder="Высота" min="3" max="15">
            </div>
            <button class="action-button" id="createCustomBoardButton">Создать доску</button>
        </form>
        <button class="menu-button" id="startGameFinalButton">Начать игру</button>
        <button class="back-button" onclick="showScreen('gamePlayModeSelectionScreen')">Назад</button>
    </div>
    <div id="gameScreen" class="screen">
        <h2 id="gameTitle">Крестики-Нолики</h2>
        <div class="status" id="status">Ход игрока X</div>
        <div class="board" id="board">
            </div>
        <button id="resetButtonGame">Начать заново</button>
        <button class="back-button" id="backToMenuGame" onclick="showScreen('mainMenuScreen', true)">В меню</button>
    </div>

    <div id="historyScreen" class="screen">
        <h2 id="historyTitle">История побед</h2>
        <ul id="historyList">
            </ul>
        <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
            <button class="action-button" id="clearHistoryButton" style="width: auto;">Очистить историю</button>
            <button class="back-button" id="backToMenuHistory" onclick="showScreen('mainMenuScreen')" style="width: auto;">В меню</button>
        </div>
    </div>

    <div id="settingsScreen" class="screen">
        <h2 id="settingsTitle">Настройки</h2>
        
        <h3><span id="languageSettingsTitle">Язык:</span> <span id="currentLanguageDisplay">Русский</span></h3>
        <div class="language-options-container" id="languageOptionsContainer">
            </div>

        <button class="menu-button" id="supportButton" style="width: auto; padding: 15px 40px; margin-top: 20px;">Написать в поддержку</button>

        <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; justify-content: center;">
            <button class="action-button" id="applySettingsButton" style="width: auto;">Применить</button>
            <button class="back-button" id="backToMenuSettings" onclick="confirmCancelSettings()" style="width: auto;">В меню</button>
        </div>
    </div>

    <div id="themesScreen" class="screen">
        <h2 id="themesTitle">Выбор Темы</h2>
        <div class="themes-container">
            <div id="eventThemes" class="themes-category event-themes">
                <h3 id="eventThemesTitle">Эвентные</h3>
                <div class="themes-grid">
                    </div>
            </div>
            <div id="ordinaryThemes" class="themes-category">
                <h3 id="ordinaryThemesTitle">Обычные</h3>
                <div class="themes-grid">
                    </div>
            </div>

            <div id="specialThemes" class="themes-category">
                <h3 id="specialThemesTitle">Особые</h3>
                <div class="themes-grid">
                    </div>
            </div>
        </div>
        <button class="back-button" id="backToMenuThemes" onclick="showScreen('mainMenuScreen')">В меню</button>
    </div>

    <div id="languageModal" class="modal">
        <div class="modal-content">
            <h3 id="languageModalTitle"></h3>
            <div class="language-options-container" id="firstTimeLanguageOptions">
                </div>
        </div>
    </div>

    <div id="clearHistoryConfirmModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('clearHistoryConfirmModal')">&times;</span>
            <h3 id="clearHistoryConfirmTitle">Вы уверены, что хотите очистить историю?</h3>
            <div class="modal-buttons">
                <button class="menu-button" id="confirmClearHistoryButton"></button>
                <button class="back-button" onclick="closeModal('clearHistoryConfirmModal')"></button>
            </div>
        </div>
    </div>

    <div id="cancelSettingsConfirmModal" class="modal">
        <div class="modal-content">
            <h3 id="cancelSettingsConfirmTitle"></h3>
            <div class="modal-buttons">
                <button class="menu-button" id="cancelSettingsStayButton"></button>
                <button class="back-button" id="cancelSettingsDiscardButton"></button>
            </div>
        </div>
    </div>

    <div id="cancelGameCreationConfirmModal" class="modal">
        <div class="modal-content">
            <h3 id="cancelGameCreationConfirmTitle"></h3>
            <div class="modal-buttons">
                <button class="menu-button" id="cancelGameCreationStayButton"></button>
                <button class="back-button" id="cancelGameCreationDiscardButton"></button>
            </div>
        </div>
    </div>

    <div id="notificationModal" class="modal notification-modal">
        <div class="modal-content">
            <h3 id="notificationModalTitle"></h3>
            <div class="modal-buttons">
                <button class="menu-button" onclick="closeModal('notificationModal')">ОК</button>
            </div>
        </div>
    </div>


    <script>
        // Элементы DOM
        const screens = document.querySelectorAll('.screen');
        const boardElement = document.getElementById('board');
        const statusDisplay = document.getElementById('status');
        const resetButtonGame = document.getElementById('resetButtonGame');
        const historyListElement = document.getElementById('historyList');
        const ordinaryThemesGridElement = document.querySelector('#ordinaryThemes .themes-grid');
        const specialThemesGridElement = document.querySelector('#specialThemes .themes-grid');
        const eventThemesGridElement = document.querySelector('#eventThemes .themes-grid');
        const root = document.documentElement;

        const languageModal = document.getElementById('languageModal');
        const languageModalTitle = document.getElementById('languageModalTitle');
        const firstTimeLanguageOptions = document.getElementById('firstTimeLanguageOptions');

        const settingsLanguageOptionsContainer = document.getElementById('languageOptionsContainer');
        const currentLanguageDisplay = document.getElementById('currentLanguageDisplay');
        const applySettingsButton = document.getElementById('applySettingsButton');
        const supportButton = document.getElementById('supportButton');

        const clearHistoryButton = document.getElementById('clearHistoryButton');
        const clearHistoryConfirmModal = document.getElementById('clearHistoryConfirmModal');
        const confirmClearHistoryButton = document.getElementById('confirmClearHistoryButton');

        const cancelSettingsConfirmModal = document.getElementById('cancelSettingsConfirmModal');
        const cancelSettingsStayButton = document.getElementById('cancelSettingsStayButton');
        const cancelSettingsDiscardButton = document.getElementById('cancelSettingsDiscardButton');

        const playButton = document.getElementById('playButton');
        const ticTacToeButton = document.getElementById('ticTacToeButton');
        const ticTacToeBlastButton = document.getElementById('ticTacToeBlastButton');
        const playOnPhoneButton = document.getElementById('playOnPhoneButton');
        const playViaWifiButton = document.getElementById('playViaWifiButton');
        const playViaBluetoothButton = document.getElementById('playViaBluetoothButton');

        const prevBoardSizeButton = document.getElementById('prevBoardSize');
        const nextBoardSizeButton = document.getElementById('nextBoardSize');
        const currentBoardSizeDisplay = document.getElementById('currentBoardSizeDisplay');
        const customWidthInput = document.getElementById('customWidth');
        const customHeightInput = document.getElementById('customHeight');
        const createCustomBoardButton = document.getElementById('createCustomBoardButton');
        const startGameFinalButton = document.getElementById('startGameFinalButton');

        const cancelGameCreationConfirmModal = document.getElementById('cancelGameCreationConfirmModal');
        const cancelGameCreationConfirmTitle = document.getElementById('cancelGameCreationConfirmTitle');
        const cancelGameCreationStayButton = document.getElementById('cancelGameCreationStayButton');
        const cancelGameCreationDiscardButton = document.getElementById('cancelGameCreationDiscardButton');

        const notificationModal = document.getElementById('notificationModal');
        const notificationModalTitle = document.getElementById('notificationModalTitle');

        // Состояние игры
        let currentPlayer = 'X';
        let gameActive = true;
        let gameState = ["", "", "", "", "", "", "", "", ""];
        let gameStartTime;
        let gameHistory = JSON.parse(localStorage.getItem('ticTacToeHistory')) || [];

        let currentBoardWidth = 3;
        let currentBoardHeight = 3;
        let initialBoardSize = { width: 3, height: 3 }; // Сохраняем для сброса

        const predefinedBoardSizes = [
            { width: 3, height: 3 },
            { width: 3, height: 4 },
            { width: 3, height: 5 },
            { width: 4, height: 4 },
            { width: 4, height: 5 },
            { width: 4, height: 6 },
            { width: 5, height: 5 },
            { width: 5, height: 6 },
            { width: 5, height: 7 },
            { width: 6, height: 6 },
            { width: 6, height: 7 },
            { width: 6, height: 8 },
            { width: 7, height: 7 },
            { width: 7, height: 8 },
            { width: 7, height: 9 },
            { width: 8, height: 8 },
            { width: 8, height: 9 },
            { width: 8, height: 10 },
            { width: 9, height: 9 },
            { width: 9, height: 10 },
            { width: 9, height: 11 },
            { width: 10, height: 10 },
            { width: 10, height: 11 },
            { width: 10, height: 12 }
        ];
        let currentBoardSizeIndex = 0; // Индекс для предопределенных размеров

        const winningConditions = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8],
            [0, 3, 6], [1, 4, 7], [2, 5, 8],
            [0, 4, 8], [2, 4, 6]
        ];

        // --- Локализация ---
        const translations = {
            'ru': {
                'play': 'Играть',
                'history': 'История игр',
                'themes': 'Темы',
                'settings': 'Настройки',
                'game_title': 'Крестики-Нолики',
                'turn_x': 'Ход игрока X',
                'turn_o': 'Ход игрока O',
                'player_x_wins': 'Игрок X победил за',
                'player_o_wins': 'Игрок O победил за',
                'draw': 'Ничья за',
                'seconds': 'сек!',
                'start_new': 'Начать заново',
                'back_to_menu': 'В меню',
                'history_title': 'История побед',
                'history_empty': 'История пока пуста. Сыграйте партию!',
                'clear_history': 'Очистить историю',
                'confirm_clear_history': 'Вы уверены, что хотите очистить историю?',
                'yes_clear': 'Да, очистить',
                'cancel': 'Отмена',
                'themes_title': 'Выбор Темы',
                'event_themes': 'Эвентные',
                'ordinary_themes': 'Обычные',
                'special_themes': 'Особые',
                'settings_title': 'Настройки',
                'select_your_language': 'Выберите свой язык',
                'language': 'Язык:',
                'write_to_support': 'Написать в поддержку',
                'apply': 'Применить',
                'confirm_cancel_settings': 'Вы действительно хотите отменить несохраненные изменения?',
                'discard': 'Отменить',
                'game_by': 'Игра от',
                'theme_default': 'По Умолчанию',
                'theme_forest': 'Лес',
                'theme_ocean': 'Океан',
                'theme_lava': 'Лава',
                'theme_excellent_poor': 'Отличник vs Двоечник',
                'theme_stars_moon': 'Звезды и Луна',
                'theme_stars_moon_emoji': 'Звезды и Луна (Эмодзи)',
                'theme_boring_lessons': 'Скучные Уроки',
                'theme_water_vs_lava': 'Вода vs Лава',
                'theme_summer_emoji': 'Лето в эмодзи',
                'select_game_mode': 'Выбери режим игры',
                'tic_tac_toe': 'Крестики-Нолики',
                'tic_tac_toe_blast': 'Tic Tac Toe Blast!',
                'mode_under_development': 'Открыть невозможно, еще в разработке.',
                'select_game_play_mode': 'На чем играть?',
                'play_on_phone': 'На телефоне',
                'play_via_wifi': 'По Wi-Fi',
                'play_via_bluetooth': 'По Bluetooth',
                'network_under_development': 'Нельзя играть по сети, еще в разработке.',
                'select_board_size': 'Выбери размер доски',
                'custom_board': 'Сделать свою доску:',
                'width': 'Ширина',
                'height': 'Высота',
                'create_board': 'Создать доску',
                'start_game': 'Начать игру',
                'confirm_cancel_game_creation': 'Вы действительно хотите прервать создание игры?',
                'continue_creation': 'Отмена',
                'abort_creation': 'Прервать',
                'invalid_board_size': 'Некорректный размер доски. Ширина и высота должны быть от 3 до 15.'
            },
            'en': {
                'play': 'Play',
                'history': 'Game History',
                'themes': 'Themes',
                'settings': 'Settings',
                'game_title': 'Tic-Tac-Toe',
                'turn_x': 'X\'s Turn',
                'turn_o': 'O\'s Turn',
                'player_x_wins': 'Player X won in',
                'player_o_wins': 'Player O won in',
                'draw': 'Draw in',
                'seconds': 'sec!',
                'start_new': 'Start New Game',
                'back_to_menu': 'Back to Menu',
                'history_title': 'Win History',
                'history_empty': 'History is empty. Play a game!',
                'clear_history': 'Clear History',
                'confirm_clear_history': 'Are you sure you want to clear history?',
                'yes_clear': 'Yes, clear',
                'cancel': 'Cancel',
                'themes_title': 'Choose Theme',
                'event_themes': 'Event Themes',
                'ordinary_themes': 'Ordinary',
                'special_themes': 'Special',
                'settings_title': 'Settings',
                'select_your_language': 'Select your language',
                'language': 'Language:',
                'write_to_support': 'Write to support',
                'apply': 'Apply',
                'confirm_cancel_settings': 'Do you really want to discard unsaved changes?',
                'discard': 'Discard',
                'game_by': 'Game by',
                'theme_default': 'Default',
                'theme_forest': 'Forest',
                'theme_ocean': 'Ocean',
                'theme_lava': 'Lava',
                'theme_excellent_poor': 'A-Student vs F-Student',
                'theme_stars_moon': 'Stars and Moon',
                'theme_stars_moon_emoji': 'Stars and Moon (Emoji)',
                'theme_boring_lessons': 'Boring Lessons',
                'theme_water_vs_lava': 'Water vs Lava',
                'theme_summer_emoji': 'Summer in Emoji',
                'select_game_mode': 'Select Game Mode',
                'tic_tac_toe': 'Tic-Tac-Toe',
                'tic_tac_toe_blast': 'Tic Tac Toe Blast!',
                'mode_under_development': 'Cannot open, still under development.',
                'select_game_play_mode': 'How to Play?',
                'play_on_phone': 'On this Phone',
                'play_via_wifi': 'Via Wi-Fi',
                'play_via_bluetooth': 'Via Bluetooth',
                'network_under_development': 'Cannot play online, still under development.',
                'select_board_size': 'Select Board Size',
                'custom_board': 'Create custom board:',
                'width': 'Width',
                'height': 'Height',
                'create_board': 'Create Board',
                'start_game': 'Start Game',
                'confirm_cancel_game_creation': 'Do you really want to abort game creation?',
                'continue_creation': 'Cancel',
                'abort_creation': 'Abort',
                'invalid_board_size': 'Invalid board size. Width and height must be between 3 and 15.'
            },
            'es': {
                'play': 'Jugar',
                'history': 'Historial de Juegos',
                'themes': 'Temas',
                'settings': 'Configuración',
                'game_title': 'Tres en Raya',
                'turn_x': 'Turno de X',
                'turn_o': 'Turno de O',
                'player_x_wins': 'El jugador X ganó en',
                'player_o_wins': 'El jugador O ganó en',
                'draw': 'Empate en',
                'seconds': 'seg!',
                'start_new': 'Empezar de Nuevo',
                'back_to_menu': 'Volver al Menú',
                'history_title': 'Historial de Victorias',
                'history_empty': 'Historial vacío. ¡Juega una partida!',
                'clear_history': 'Borrar Historial',
                'confirm_clear_history': '¿Seguro que quieres borrar el historial?',
                'yes_clear': 'Sí, borrar',
                'cancel': 'Cancelar',
                'themes_title': 'Elegir Tema',
                'event_themes': 'Temas de Evento',
                'ordinary_themes': 'Ordinarios',
                'special_themes': 'Especiales',
                'settings_title': 'Configuración',
                'select_your_language': 'Selecciona tu idioma',
                'language': 'Idioma:',
                'write_to_support': 'Escribir a soporte',
                'apply': 'Aplicar',
                'confirm_cancel_settings': '¿Realmente quieres descartar los cambios no guardados?',
                'discard': 'Descartar',
                'game_by': 'Juego por',
                'theme_default': 'Por Defecto',
                'theme_forest': 'Bosque',
                'theme_ocean': 'Océano',
                'theme_lava': 'Lava',
                'theme_excellent_poor': 'Estudiante A vs Estudiante F',
                'theme_stars_moon': 'Estrellas y Luna',
                'theme_stars_moon_emoji': 'Estrellas y Luna (Emoji)',
                'theme_boring_lessons': 'Clases Aburridas',
                'theme_water_vs_lava': 'Agua vs Lava',
                'theme_summer_emoji': 'Verano en Emoji',
                'select_game_mode': 'Seleccionar Modo de Juego',
                'tic_tac_toe': 'Tres en Raya',
                'tic_tac_toe_blast': 'Tres en Raya Blast!',
                'mode_under_development': 'No se puede abrir, aún en desarrollo.',
                'select_game_play_mode': '¿Cómo jugar?',
                'play_on_phone': 'En este Teléfono',
                'play_via_wifi': 'Por Wi-Fi',
                'play_via_bluetooth': 'Por Bluetooth',
                'network_under_development': 'No se puede jugar en línea, aún en desarrollo.',
                'select_board_size': 'Seleccionar Tamaño del Tablero',
                'custom_board': 'Crear tablero personalizado:',
                'width': 'Ancho',
                'height': 'Altura',
                'create_board': 'Crear Tablero',
                'start_game': 'Iniciar Juego',
                'confirm_cancel_game_creation': '¿Realmente quieres abortar la creación del juego?',
                'continue_creation': 'Cancelar',
                'abort_creation': 'Abortar',
                'invalid_board_size': 'Tamaño de tablero no válido. El ancho y alto deben estar entre 3 y 15.'
            },
            'pt': {
                'play': 'Jogar',
                'history': 'Histórico de Jogos',
                'themes': 'Temas',
                'settings': 'Configurações',
                'game_title': 'Jogo da Velha',
                'turn_x': 'Vez de X',
                'turn_o': 'Vez de O',
                'player_x_wins': 'Jogador X venceu em',
                'player_o_wins': 'Jogador O venceu em',
                'draw': 'Empate em',
                'seconds': 'seg!',
                'start_new': 'Começar Novo Jogo',
                'back_to_menu': 'Voltar ao Menu',
                'history_title': 'Histórico de Vitórias',
                'history_empty': 'Histórico vazio. Jogue uma partida!',
                'clear_history': 'Limpar Histórico',
                'confirm_clear_history': 'Tem certeza de que deseja limpar o histórico?',
                'yes_clear': 'Sim, limpar',
                'cancel': 'Cancelar',
                'themes_title': 'Escolher Tema',
                'event_themes': 'Temas de Evento',
                'ordinary_themes': 'Ordinários',
                'special_themes': 'Especiais',
                'settings_title': 'Configurações',
                'select_your_language': 'Selecione seu idioma',
                'language': 'Idioma:',
                'write_to_support': 'Escrever para suporte',
                'apply': 'Aplicar',
                'confirm_cancel_settings': 'Deseja realmente descartar as alterações não salvas?',
                'discard': 'Descartar',
                'game_by': 'Jogo por',
                'theme_default': 'Padrão',
                'theme_forest': 'Floresta',
                'theme_ocean': 'Oceano',
                'theme_lava': 'Lava',
                'theme_excellent_poor': 'Aluno A vs Aluno F',
                'theme_stars_moon': 'Estrelas e Lua',
                'theme_stars_moon_emoji': 'Estrelas e Lua (Emoji)',
                'theme_boring_lessons': 'Aulas Chatas',
                'theme_water_vs_lava': 'Água vs Lava',
                'theme_summer_emoji': 'Verão em Emoji',
                'select_game_mode': 'Selecionar Modo de Jogo',
                'tic_tac_toe': 'Jogo da Velha',
                'tic_tac_toe_blast': 'Jogo da Velha Blast!',
                'mode_under_development': 'Não é possível abrir, ainda em desenvolvimento.',
                'select_game_play_mode': 'Como Jogar?',
                'play_on_phone': 'Neste Telefone',
                'play_via_wifi': 'Via Wi-Fi',
                'play_via_bluetooth': 'Via Bluetooth',
                'network_under_development': 'Não é possível jogar online, ainda em desenvolvimento.',
                'select_board_size': 'Selecionar Tamanho do Tabuleiro',
                'custom_board': 'Criar tabuleiro personalizado:',
                'width': 'Largura',
                'height': 'Altura',
                'create_board': 'Criar Tabuleiro',
                'start_game': 'Iniciar Jogo',
                'confirm_cancel_game_creation': 'Deseja realmente abortar a criação do jogo?',
                'continue_creation': 'Cancelar',
                'abort_creation': 'Abortar',
                'invalid_board_size': 'Tamanho de tabuleiro inválido. Largura e altura devem estar entre 3 e 15.'
            },
            'it': {
                'play': 'Gioca',
                'history': 'Cronologia Partite',
                'themes': 'Temi',
                'settings': 'Impostazioni',
                'game_title': 'Tris',
                'turn_x': 'Turno di X',
                'turn_o': 'Turno di O',
                'player_x_wins': 'Giocatore X ha vinto in',
                'player_o_wins': 'Giocatore O ha vinto in',
                'draw': 'Pareggio in',
                'seconds': 'sec!',
                'start_new': 'Inizia Nuova Partita',
                'back_to_menu': 'Torna al Menu',
                'history_title': 'Cronologia Vittorie',
                'history_empty': 'Cronologia vuota. Gioca una partita!',
                'clear_history': 'Cancella Cronologia',
                'confirm_clear_history': 'Sei sicuro di voler cancellare la cronologia?',
                'yes_clear': 'Sì, cancella',
                'cancel': 'Annulla',
                'themes_title': 'Scegli Tema',
                'event_themes': 'Temi Evento',
                'ordinary_themes': 'Ordinari',
                'special_themes': 'Speciali',
                'settings_title': 'Impostazioni',
                'select_your_language': 'Seleziona la tua lingua',
                'language': 'Lingua:',
                'write_to_support': 'Scrivi al supporto',
                'apply': 'Applica',
                'confirm_cancel_settings': 'Vuoi davvero scartare le modifiche non salvate?',
                'discard': 'Scarta',
                'game_by': 'Gioco di',
                'theme_default': 'Predefinito',
                'theme_forest': 'Foresta',
                'theme_ocean': 'Oceano',
                'theme_lava': 'Lava',
                'theme_excellent_poor': 'Studente A vs Studente F',
                'theme_stars_moon': 'Stelle e Luna',
                'theme_stars_moon_emoji': 'Stelle e Luna (Emoji)',
                'theme_boring_lessons': 'Lezioni noiose',
                'theme_water_vs_lava': 'Acqua vs Lava',
                'theme_summer_emoji': 'Estate in Emoji',
                'select_game_mode': 'Seleziona Modalità di Gioco',
                'tic_tac_toe': 'Tris',
                'tic_tac_toe_blast': 'Tris Blast!',
                'mode_under_development': 'Non apribile, ancora in fase di sviluppo.',
                'select_game_play_mode': 'Come Giocare?',
                'play_on_phone': 'Su questo Telefono',
                'play_via_wifi': 'Tramite Wi-Fi',
                'play_via_bluetooth': 'Tramite Bluetooth',
                'network_under_development': 'Non è possibile giocare online, ancora in fase di sviluppo.',
                'select_board_size': 'Seleziona Dimensione Tabellone',
                'custom_board': 'Crea tabellone personalizzato:',
                'width': 'Larghezza',
                'height': 'Altezza',
                'create_board': 'Crea Tabellone',
                'start_game': 'Inizia Partita',
                'confirm_cancel_game_creation': 'Vuoi davvero annullare la creazione del gioco?',
                'continue_creation': 'Annulla',
                'abort_creation': 'Annulla',
                'invalid_board_size': 'Dimensione tabellone non valida. Larghezza e altezza devono essere tra 3 e 15.'
            }
        };

        const languageNames = {
            'ru': 'Русский',
            'en': 'English',
            'es': 'Español',
            'pt': 'Português',
            'it': 'Italiano'
        };

        let currentLanguage = localStorage.getItem('ticTacToeLanguage') || 'en';
        let tempSettingsLanguage = currentLanguage;

         // --- Определение Тем ---
         const themes = {
             'summer-emoji': {
                 nameKey: 'theme_summer_emoji', // Ключ для перевода
                 category: 'event',
                 vars: {
                    '--main-bg': '#add8e6',
                    '--container-bg': '#87ceeb',
                    '--button-bg': 'linear-gradient(90deg, #4682b4, #ffd700)',
                    '--button-hover-bg': 'linear-gradient(90deg, #5b9bd5, #ffe400)',
                    '--x-color': '#0056b3',
                    '--o-color': '#ffbe0b',
                    '--text-color': '#333333',
                    '--border-color': '#60a5fa',
                    '--shadow-color': 'rgba(0, 0, 0, 0.3)',
                    '--body-bg-start': '#87ceeb',
                    '--body-bg-end': '#ffd700',
                    '--body-bg-direction': '45deg',
                    '--body-bg-size': '200% 200%',
                    '--body-bg-animation': 'gradientShift 15s ease infinite alternate',
                    '--body-bg-image': 'none',
                    '--body-bg-repeat': 'no-repeat',
                    '--body-bg-position': 'center center',
                 },
                 marks: { x: '🌧️', o: '☀️' },
                 preview: { '--preview-x-color': '#0056b3', '--preview-o-color': '#ffbe0b' }
             },
             'default': {
                 nameKey: 'theme_default',
                 category: 'ordinary',
                 vars: {
                    '--main-bg': '#1f2937',
                    '--container-bg': '#374151',
                    '--button-bg': '#4f46e5',
                    '--button-hover-bg': '#6366f1',
                    '--x-color': '#ef4444',
                    '--o-color': '#3b82f6',
                    '--text-color': '#f3f4f6',
                    '--border-color': '#6b7280',
                    '--shadow-color': 'rgba(0, 0, 0, 0.6)',
                    '--body-bg-start': '#111827',
                    '--body-bg-end': '#1f2937',
                    '--body-bg-direction': '135deg',
                    '--body-bg-size': 'auto',
                    '--body-bg-animation': 'none',
                    '--body-bg-image': 'none',
                    '--body-bg-repeat': 'no-repeat',
                    '--body-bg-position': 'center center',
                 },
                 marks: { x: 'X', o: 'O' },
                 preview: { '--preview-x-color': '#ef4444', '--preview-o-color': '#3b82f6' }
             },
             'forest': {
                 nameKey: 'theme_forest',
                 category: 'ordinary',
                 vars: {
                    '--main-bg': '#1e3a24',
                    '--container-bg': '#224d2b',
                    '--button-bg': '#346c41',
                    '--button-hover-bg': '#4a805a',
                    '--x-color': '#facc15',
                    '--o-color': '#a7f3d0',
                    '--text-color': '#d1fae5',
                    '--border-color': '#4b5563',
                    '--shadow-color': 'rgba(0, 0, 0, 0.6)',
                    '--body-bg-start': '#064e3b',
                    '--body-bg-end': '#1e3a24',
                    '--body-bg-direction': 'top right',
                    '--body-bg-size': 'auto',
                    '--body-bg-animation': 'none',
                    '--body-bg-image': 'none',
                    '--body-bg-repeat': 'no-repeat',
                    '--body-bg-position': 'center center',
                 },
                 marks: { x: 'X', o: 'O' },
                 preview: { '--preview-x-color': '#facc15', '--preview-o-color': '#a7f3d0' }
             },
             'ocean': {
                 nameKey: 'theme_ocean',
                 category: 'ordinary',
                 vars: {
                    '--main-bg': '#1e3a8a',
                    '--container-bg': '#1c4a7b',
                    '--button-bg': '#2563eb',
                    '--button-hover-bg': '#3b82f6',
                    '--x-color': '#f87171',
                    '--o-color': '#bfdbfe',
                    '--text-color': '#eff6ff',
                    '--border-color': '#60a5fa',
                    '--shadow-color': 'rgba(0, 0, 0, 0.6)',
                    '--body-bg-start': '#0b173b',
                    '--body-bg-end': '#1e3a8a',
                    '--body-bg-direction': 'bottom left',
                    '--body-bg-size': 'auto',
                    '--body-bg-animation': 'none',
                    '--body-bg-image': 'none',
                    '--body-bg-repeat': 'no-repeat',
                    '--body-bg-position': 'center center',
                 },
                 marks: { x: 'X', o: 'O' },
                 preview: { '--preview-x-color': '#f87171', '--preview-o-color': '#bfdbfe' }
             },
              'lava': {
                 nameKey: 'theme_lava',
                 category: 'ordinary',
                 vars: {
                    '--main-bg': '#450a0a',
                    '--container-bg': '#7f1d1d',
                    '--button-bg': '#dc2626',
                    '--button-hover-bg': '#ef4444',
                    '--x-color': '#fef08a',
                    '--o-color': '#f97316',
                    '--text-color': '#fef2f2',
                    '--border-color': '#b91c1c',
                    '--shadow-color': 'rgba(0, 0, 0, 0.8)',
                    '--body-bg-start': '#0c0606',
                    '--body-bg-end': '#450a0a',
                    '--body-bg-direction': 'to top',
                    '--body-bg-size': '600% 600%',
                    '--body-bg-animation': 'gradientShift 30s ease infinite',
                    '--body-bg-image': 'none',
                    '--body-bg-repeat': 'no-repeat',
                    '--body-bg-position': 'center center',
                 },
                 marks: { x: 'X', o: 'O' },
                 preview: { '--preview-x-color': '#fef08a', '--preview-o-color': '#f97316' }
             },
             'excellent-poor': {
                 nameKey: 'theme_excellent_poor',
                 category: 'special',
                 vars: {
                    '--main-bg': '#ffffff',
                    '--container-bg': '#f0f0f0',
                    '--button-bg': '#4CAF50',
                    '--button-hover-bg': '#66BB6A',
                    '--x-color': '#ef4444',
                    '--o-color': '#3b82f6',
                    '--text-color': '#333333',
                    '--border-color': '#cccccc',
                    '--shadow-color': 'rgba(0, 0, 0, 0.2)',
                    '--body-bg-start': 'transparent', /* Прозрачный, чтобы не накладывался на изображение */
                    '--body-bg-end': 'transparent',
                    '--body-bg-direction': '135deg',
                    '--body-bg-size': 'cover', /* Фон покрывает всю область */
                    '--body-bg-animation': 'none',
                    '--body-bg-image': 'url("bg.jpg")', /* Используем изображение */
                    '--body-bg-repeat': 'no-repeat',
                    '--body-bg-position': 'center center',
                 },
                 marks: { x: '2', o: '5' },
                 preview: { '--preview-x-color': '#ef4444', '--preview-o-color': '#3b82f6' }
             },
             'stars-moon': {
                 nameKey: 'theme_stars_moon',
                 category: 'special',
                 vars: {
                    '--main-bg': '#0a0a23',
                    '--container-bg': '#1a1a3b',
                    '--button-bg': '#3a245c',
                    '--button-hover-bg': '#5a3b8d',
                    '--x-color': '#ffffa0',
                    '--o-color': '#f0f0f0',
                    '--text-color': '#e0e0ff',
                    '--border-color': '#404060',
                    '--shadow-color': 'rgba(0, 0, 0, 0.8)',
                    '--body-bg-start': '#000000',
                    '--body-bg-end': '#1a1a3b',
                    '--body-bg-direction': 'to bottom right',
                    '--body-bg-size': 'auto',
                    '--body-bg-animation': 'none',
                    '--body-bg-image': 'none',
                    '--body-bg-repeat': 'no-repeat',
                    '--body-bg-position': 'center center',
                 },
                 marks: { x: 'X', o: 'O' },
                 preview: { '--preview-x-color': '#ffffa0', '--preview-o-color': '#f0f0f0' }
             },
             'stars-moon-emoji': {
                 nameKey: 'theme_stars_moon_emoji',
                 category: 'special',
                 vars: {
                    '--main-bg': '#0a0a23',
                    '--container-bg': '#1a1a3b',
                    '--button-bg': '#3a245c',
                    '--button-hover-bg': '#5a3b8d',
                    '--x-color': '#ffffa0',
                    '--o-color': '#f0f0f0',
                    '--text-color': '#e0e0ff',
                    '--border-color': '#404060',
                    '--shadow-color': 'rgba(0, 0, 0, 0.8)',
                    '--body-bg-start': '#000000',
                    '--body-bg-end': '#1a1a3b',
                    '--body-bg-direction': 'to bottom right',
                    '--body-bg-size': 'auto',
                    '--body-bg-animation': 'none',
                    '--body-bg-image': 'none',
                    '--body-bg-repeat': 'no-repeat',
                    '--body-bg-position': 'center center',
                 },
                 marks: { x: '⭐', o: '🌕' },
                 preview: { '--preview-x-color': '#ffffa0', '--preview-o-color': '#f0f0f0' }
             },
             'boring-lessons': {
                 nameKey: 'theme_boring_lessons',
                 category: 'ordinary',
                 vars: {
                    '--main-bg': '#ffffff',
                    '--container-bg': '#f0f0f0',
                    '--button-bg': '#6b7280',
                    '--button-hover-bg': '#9ca3af',
                    '--x-color': 'black',
                    '--o-color': 'black',
                    '--text-color': '#333333',
                    '--border-color': '#cccccc',
                    '--shadow-color': 'rgba(0, 0, 0, 0.2)',
                    '--body-bg-start': 'transparent', /* Прозрачный, чтобы не накладывался на изображение */
                    '--body-bg-end': 'transparent',
                    '--body-bg-direction': '135deg',
                    '--body-bg-size': 'cover', /* Фон покрывает всю область */
                    '--body-bg-animation': 'none',
                    '--body-bg-image': 'url("bg.jpg")', /* Используем изображение */
                    '--body-bg-repeat': 'no-repeat',
                    '--body-bg-position': 'center center',
                 },
                 marks: { x: 'X', o: 'O' },
                 preview: { '--preview-x-color': 'black', '--preview-o-color': 'black' }
             },
             'water-vs-lava': {
                 nameKey: 'theme_water_vs_lava',
                 category: 'ordinary',
                 vars: {
                    '--main-bg': '#ff4500',
                    '--container-bg': '#4169e1',
                    '--button-bg': 'linear-gradient(90deg, #ff4500, #4169e1)',
                    '--button-hover-bg': 'linear-gradient(90deg, #ff6347, #6a5acd)',
                    '--x-color': '#ff4500',
                    '--o-color': '#4169e1',
                    '--text-color': '#f3f4f6',
                    '--border-color': '#808080',
                    '--shadow-color': 'rgba(0, 0, 0, 0.6)',
                    '--body-bg-start': '#ff4500',
                    '--body-bg-end': '#4169e1',
                    '--body-bg-direction': '45deg',
                    '--body-bg-size': '200% 200%',
                    '--body-bg-animation': 'gradientShift 20s ease infinite alternate',
                    '--body-bg-image': 'none',
                    '--body-bg-repeat': 'no-repeat',
                    '--body-bg-position': 'center center',
                 },
                 marks: { x: 'X', o: 'O' },
                 preview: { '--preview-x-color': '#ff4500', '--preview-o-color': '#4169e1' }
             }
         };

        let currentThemeKey = localStorage.getItem('ticTacToeTheme') || 'default';


        // --- Управление экранами ---
        let currentActiveScreen = 'mainMenuScreen';
        let previousScreenStack = [];

        function showScreen(screenId, resetGame = false, pushToStack = true) {
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');

            // Управление стеком предыдущих экранов
            if (pushToStack && currentActiveScreen && currentActiveScreen !== screenId) {
                 previousScreenStack.push(currentActiveScreen);
             }
            currentActiveScreen = screenId;


            // Сброс игры при переходе на другие экраны
            // Этот блок нужно обновить, чтобы он срабатывал только при выходе из gameScreen
            // или при явном запросе на сброс
            if (screenId === 'gameScreen') {
                if (resetGame || !gameActive || (currentBoardWidth !== initialBoardSize.width || currentBoardHeight !== initialBoardSize.height)) {
                    startGame(currentBoardWidth, currentBoardHeight);
                }
            } else if (currentActiveScreen === 'gameScreen' && screenId !== 'gameScreen') {
                // Если уходим с игрового экрана, сбрасываем игру до дефолтного состояния
                startGame(3, 3); // Сбрасываем к 3x3 по умолчанию при выходе
            }


            // Если переходим на экран настроек, обновляем список языков
            if (screenId === 'settingsScreen') {
                populateLanguageOptions(settingsLanguageOptionsContainer, tempSettingsLanguage, (lang) => {
                    tempSettingsLanguage = lang;
                    currentLanguageDisplay.textContent = languageNames[tempSettingsLanguage];
                });
            }
            if (screenId === 'themesScreen') {
                 populateThemesGrid();
            }
            // Обновляем текст при смене экрана
            updateTextContent();
            // Обновляем размер доски на экране выбора, если это boardSizeSelectionScreen
            if (screenId === 'boardSizeSelectionScreen') {
                updateBoardSizeDisplay();
            }
        }

        // Функция для возврата на предыдущий экран
        function goBack() {
            if (previousScreenStack.length > 0) {
                const prevScreenId = previousScreenStack.pop();
                showScreen(prevScreenId, false, false); // false, чтобы не добавлять текущий экран в стек снова
            } else {
                showScreen('mainMenuScreen', false, false); // Если стек пуст, возвращаемся в главное меню
            }
        }

        // --- Логика игры ---
        function startGame(width = 3, height = 3) {
            currentBoardWidth = width;
            currentBoardHeight = height;
            initialBoardSize = { width: width, height: height }; // Обновляем начальный размер

            boardElement.innerHTML = ''; // Очищаем доску
            gameState = Array(width * height).fill(""); // Инициализируем gameState под новый размер
            currentPlayer = 'X';
            gameActive = true;
            statusDisplay.textContent = `${translations[currentLanguage].turn_x}`;
            statusDisplay.style.color = root.style.getPropertyValue(currentPlayer === 'X' ? '--x-color' : '--o-color');

            gameStartTime = new Date();

            // Устанавливаем свойства grid для доски
            boardElement.style.gridTemplateColumns = `repeat(${width}, 1fr)`;
            boardElement.style.gridTemplateRows = `repeat(${height}, 1fr)`;

            // Оптимизируем размер доски под размер экрана
            const maxBoardDimension = Math.min(window.innerWidth * 0.8, window.innerHeight * 0.6, 500); // 80% ширины, 60% высоты, не более 500px
            const cellSize = maxBoardDimension / Math.max(width, height);
            boardElement.style.width = `${cellSize * width}px`;
            boardElement.style.height = `${cellSize * height}px`;


            for (let i = 0; i < (width * height); i++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                cell.dataset.index = i;
                cell.dataset.cellNumber = i + 1; // Добавляем номер ячейки
                cell.addEventListener('click', handleCellClick);

                const playerMarkSpan = document.createElement('span');
                playerMarkSpan.classList.add('player-mark');
                // playerMarkSpan.textContent будет установлен в handleCellClick

                const cellNumberSpan = document.createElement('span');
                cellNumberSpan.classList.add('cell-number');
                cellNumberSpan.textContent = i + 1; // Номер для отображения
                
                cell.appendChild(playerMarkSpan);
                cell.appendChild(cellNumberSpan); // Добавляем номер в ячейку
                
                boardElement.appendChild(cell);
            }
            // Переприменяем тему, чтобы символы были правильными
            applyTheme(currentThemeKey);
        }

        function handleCellClick(event) {
            const clickedCell = event.target.closest('.cell'); // Убедимся, что клик был по ячейке
            if (!clickedCell) return;

            const clickedCellIndex = parseInt(clickedCell.dataset.index);

            if (gameState[clickedCellIndex] !== "" || !gameActive) {
                return;
            }

            makeMove(clickedCellIndex);
        }

        function makeMove(index) {
            if (gameState[index] !== "" || !gameActive) {
                return;
            }

            gameState[index] = currentPlayer;

            const currentTheme = themes[currentThemeKey];
            const markToShow = currentPlayer === 'X' ? currentTheme.marks.x : currentTheme.marks.o;

            const cellElement = boardElement.children[index];
            const playerMarkSpan = cellElement.querySelector('.player-mark');
            const cellNumberSpan = cellElement.querySelector('.cell-number');

            playerMarkSpan.textContent = markToShow;
            cellElement.classList.add(currentPlayer.toLowerCase());
            if (currentThemeKey === 'boring-lessons') {
                cellElement.classList.add('boring-lessons');
            }
            // Скрыть номер после хода
            if (cellNumberSpan) {
                cellNumberSpan.style.opacity = '0';
            }


            checkResult();
        }

        // Функция для проверки победы на доске произвольного размера
        function checkWin(width, height) {
            const board = gameState;

            // Проверка по горизонтали
            for (let r = 0; r < height; r++) {
                for (let c = 0; c <= width - 3; c++) {
                    const idx = r * width + c;
                    if (board[idx] !== '' && board[idx] === board[idx + 1] && board[idx + 1] === board[idx + 2]) {
                        return true;
                    }
                }
            }

            // Проверка по вертикали
            for (let c = 0; c < width; c++) {
                for (let r = 0; r <= height - 3; r++) {
                    const idx = r * width + c;
                    if (board[idx] !== '' && board[idx] === board[idx + width] && board[idx + width] === board[idx + 2 * width]) {
                        return true;
                    }
                }
            }

            // Проверка по диагонали (сверху-влево на снизу-вправо)
            for (let r = 0; r <= height - 3; r++) {
                for (let c = 0; c <= width - 3; c++) {
                    const idx = r * width + c;
                    if (board[idx] !== '' && board[idx] === board[idx + width + 1] && board[idx + width + 1] === board[idx + 2 * (width + 1)]) {
                        return true;
                    }
                }
            }

            // Проверка по диагонали (сверху-вправо на снизу-влево)
            for (let r = 0; r <= height - 3; r++) {
                for (let c = 2; c < width; c++) {
                    const idx = r * width + c;
                    if (board[idx] !== '' && board[idx] === board[idx + width - 1] && board[idx + width - 1] === board[idx + 2 * (width - 1)]) {
                        return true;
                    }
                }
            }

            return false;
        }


        function checkResult() {
            let roundWon = checkWin(currentBoardWidth, currentBoardHeight);

            const gameEndTime = new Date();
            const gameDuration = Math.round((gameEndTime - gameStartTime) / 1000);

            if (roundWon) {
                const playerWonText = currentPlayer === 'X' ? translations[currentLanguage].player_x_wins : translations[currentLanguage].player_o_wins;
                statusDisplay.textContent = `${playerWonText} ${gameDuration} ${translations[currentLanguage].seconds}`;
                statusDisplay.style.color = root.style.getPropertyValue(currentPlayer === 'X' ? '--x-color' : '--o-color');
                addHistoryRecord(`${translations[currentLanguage]['player_' + currentPlayer.toLowerCase() + '_wins'].split(' ')[0]} ${currentPlayer}`, gameDuration, `${currentBoardWidth}x${currentBoardHeight}`);
                gameActive = false;
                return;
            }

            if (!gameState.includes("")) {
                statusDisplay.textContent = `${translations[currentLanguage].draw} ${gameDuration} ${translations[currentLanguage].seconds}`;
                statusDisplay.style.color = root.style.getPropertyValue('--text-color');
                addHistoryRecord(translations[currentLanguage].draw, gameDuration, `${currentBoardWidth}x${currentBoardHeight}`);
                gameActive = false;
                return;
            }

            currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
            statusDisplay.textContent = `${translations[currentLanguage]['turn_' + currentPlayer.toLowerCase()]}`;
            statusDisplay.style.color = root.style.getPropertyValue(currentPlayer === 'X' ? '--x-color' : '--o-color');
        }

        resetButtonGame.addEventListener('click', () => startGame(currentBoardWidth, currentBoardHeight));

        // Обработчик нажатий клавиш для игры
        document.addEventListener('keydown', (event) => {
            // Проверяем, что активен экран игры
            if (document.getElementById('gameScreen').classList.contains('active')) {
                const keyPressed = parseInt(event.key);
                if (keyPressed >= 1 && keyPressed <= 9) { // Пока только для 3x3
                    const index = keyPressed - 1; // Номер ячейки 1-9 соответствует индексу 0-8
                    if (index < gameState.length) { // Учитываем размер доски
                        makeMove(index);
                    }
                }
            }
        });


        // --- История игр ---
        function addHistoryRecord(winner, duration, boardSize) {
            const record = {
                winner: winner,
                duration: duration,
                boardSize: boardSize, // Добавляем размер доски
                date: new Date().toLocaleString(currentLanguage === 'ru' ? 'ru-RU' : `${currentLanguage}-${currentLanguage.toUpperCase()}`)
            };
            gameHistory.unshift(record);
            if (gameHistory.length > 20) {
                gameHistory.pop();
            }
            localStorage.setItem('ticTacToeHistory', JSON.stringify(gameHistory));
        }

        function loadHistory() {
            historyListElement.innerHTML = '';
            if (gameHistory.length === 0) {
                historyListElement.innerHTML = `<li>${translations[currentLanguage].history_empty}</li>`;
                return;
            }
            gameHistory.forEach(record => {
                const listItem = document.createElement('li');
                listItem.textContent = `${record.date} - ${record.winner} (${record.boardSize}), ${translations[currentLanguage].seconds.replace('!', '')}: ${record.duration} ${translations[currentLanguage].seconds.split(' ')[0]}.`;
                historyListElement.appendChild(listItem);
            });
        }

        // Кнопка очистки истории
        clearHistoryButton.addEventListener('click', () => {
            openModal('clearHistoryConfirmModal');
        });

        confirmClearHistoryButton.addEventListener('click', () => {
            gameHistory = [];
            localStorage.removeItem('ticTacToeHistory');
            loadHistory();
            closeModal('clearHistoryConfirmModal');
        });

        // --- Управление Темами ---
        function applyTheme(themeKey) {
            const theme = themes[themeKey];
            if (!theme) {
                console.error('Тема не найдена:', themeKey);
                return;
            }

            for (const [prop, value] of Object.entries(theme.vars)) {
                root.style.setProperty(prop, value);
            }

            localStorage.setItem('ticTacToeTheme', themeKey);
            currentThemeKey = themeKey;

            updateThemesUI(); // Обновляем UI тем

            // Обновляем символы на доске, если игра активна или поле не пустое
            const cells = boardElement.children;
            for (let i = 0; i < cells.length; i++) {
                const cell = cells[i];
                const playerMarkSpan = cell.querySelector('.player-mark');
                const cellNumberSpan = cell.querySelector('.cell-number');

                // Удаляем старые классы тем
                cell.classList.remove('x', 'o', 'boring-lessons');

                if (gameState[i] !== "") {
                    const player = gameState[i];
                    const markToShow = player === 'X' ? theme.marks.x : theme.marks.o;
                    playerMarkSpan.textContent = markToShow;
                    cell.classList.add(player.toLowerCase());
                    if (currentThemeKey === 'boring-lessons') {
                         cell.classList.add('boring-lessons');
                     }
                    // Скрываем номер, если символ уже установлен
                    if (cellNumberSpan) {
                        cellNumberSpan.style.opacity = '0';
                    }
                } else {
                    // Если ячейка пуста, показываем номер и очищаем символ
                    playerMarkSpan.textContent = '';
                    if (cellNumberSpan) {
                        cellNumberSpan.style.opacity = '1';
                    }
                }
            }

            // Обновляем цвет статуса, если игра активна или завершена
            if (document.getElementById('gameScreen').classList.contains('active')) {
                 if (gameActive) {
                     statusDisplay.style.color = root.style.getPropertyValue(currentPlayer === 'X' ? '--x-color' : '--o-color');
                 } else { // Если игра завершена (победа/ничья)
                    const statusText = statusDisplay.textContent;
                    if (statusText.includes(translations[currentLanguage].player_x_wins.split(' ')[0])) {
                        statusDisplay.style.color = root.style.getPropertyValue('--x-color');
                    } else if (statusText.includes(translations[currentLanguage].player_o_wins.split(' ')[0])) {
                        statusDisplay.style.color = root.style.getPropertyValue('--o-color');
                    } else if (statusText.includes(translations[currentLanguage].draw.split(' ')[0])) {
                        statusDisplay.style.color = root.style.getPropertyValue('--text-color');
                    }
                 }
             }
        }

        function populateThemesGrid() {
             eventThemesGridElement.innerHTML = '';
             ordinaryThemesGridElement.innerHTML = '';
             specialThemesGridElement.innerHTML = '';

             for (const themeKey in themes) {
                 const theme = themes[themeKey];
                 const optionDiv = document.createElement('div');
                 optionDiv.classList.add('theme-option');
                 optionDiv.dataset.themeKey = themeKey;

                 if (themeKey === currentThemeKey) {
                     optionDiv.classList.add('selected');
                     if (theme.category === 'event') {
                         optionDiv.classList.add('event-theme');
                     }
                 }

                 const previewDiv = document.createElement('div');
                 previewDiv.classList.add('theme-preview');
                 // Применяем класс boring-lessons к превью, если это тема boring-lessons
                 if (themeKey === 'boring-lessons') {
                     previewDiv.classList.add('boring-lessons');
                 }

                 // Устанавливаем цвета для превью X и O из темы
                 previewDiv.style.setProperty('--preview-x-color', theme.preview['--preview-x-color']);
                 previewDiv.style.setProperty('--preview-o-color', theme.preview['--preview-o-color']);

                 const previewX = document.createElement('span');
                 previewX.classList.add('preview-x');
                 previewX.textContent = theme.marks.x;

                 const previewO = document.createElement('span');
                 previewO.classList.add('preview-o');
                 previewO.textContent = theme.marks.o;

                 previewDiv.appendChild(previewX);
                 previewDiv.appendChild(previewO);


                 const nameSpan = document.createElement('span');
                 // Используем ключ для перевода названия темы
                 nameSpan.textContent = translations[currentLanguage][theme.nameKey] || theme.nameKey;

                 optionDiv.appendChild(previewDiv);
                 optionDiv.appendChild(nameSpan);

                 optionDiv.addEventListener('click', () => {
                     applyTheme(themeKey);
                 });

                 if (theme.category === 'event') {
                     eventThemesGridElement.appendChild(optionDiv);
                 } else if (theme.category === 'ordinary') {
                     ordinaryThemesGridElement.appendChild(optionDiv);
                 } else if (theme.category === 'special') {
                     specialThemesGridElement.appendChild(optionDiv);
                 }
             }
        }

        function updateThemesUI() {
             const options = document.querySelectorAll('.theme-option');
             options.forEach(option => {
                 option.classList.remove('selected', 'event-theme');
                 if (option.dataset.themeKey === currentThemeKey) {
                     option.classList.add('selected');
                     if (themes[currentThemeKey].category === 'event') {
                         option.classList.add('event-theme');
                     }
                 }
                 // Обновляем название темы, если оно есть в translations
                 const themeKey = option.dataset.themeKey;
                 const theme = themes[themeKey];
                 if (theme && theme.nameKey) {
                     option.querySelector('span:last-child').textContent = translations[currentLanguage][theme.nameKey] || theme.nameKey;
                 }

                 // Убедимся, что превью обновляется при смене темы
                 const previewDiv = option.querySelector('.theme-preview');
                 const previewX = option.querySelector('.preview-x');
                 const previewO = option.querySelector('.preview-o');

                 // Удаляем и добавляем класс boring-lessons
                 previewDiv.classList.toggle('boring-lessons', themeKey === 'boring-lessons');

                 // Обновляем текстовое содержимое символов превью
                 previewX.textContent = themes[themeKey].marks.x;
                 previewO.textContent = themes[themeKey].marks.o;

                 // Обновляем цвета символов превью, если они заданы в theme.preview
                 previewDiv.style.setProperty('--preview-x-color', themes[themeKey].preview['--preview-x-color']);
                 previewDiv.style.setProperty('--preview-o-color', themes[themeKey].preview['--preview-o-color']);
             });
        }

        // --- Управление языками ---
        function applyLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('ticTacToeLanguage', lang);
            updateTextContent();
            applyTheme(currentThemeKey); // Переприменяем тему, чтобы обновились символы на доске
        }

        function updateTextContent() {
            document.getElementById('playButton').textContent = translations[currentLanguage].play;
            document.getElementById('historyButton').textContent = translations[currentLanguage].history;
            document.getElementById('themesButton').textContent = translations[currentLanguage].themes;
            document.getElementById('settingsButton').textContent = translations[currentLanguage].settings;
            document.getElementById('gameByText').textContent = translations[currentLanguage].game_by + ' ';

            document.getElementById('gameTitle').textContent = translations[currentLanguage].game_title;
            if (gameActive) {
                statusDisplay.textContent = `${translations[currentLanguage]['turn_' + currentPlayer.toLowerCase()]}`;
            } else {
                // Если игра завершена, сохраняем текущий статус, но обновляем "секунды" и "победил/ничья"
                const lastStatus = statusDisplay.textContent;
                const durationMatch = lastStatus.match(/\d+/); // Находим число (длительность)
                const duration = durationMatch ? parseInt(durationMatch[0]) : '';

                // Проверяем, какой язык был использован в последнем статусе, и соответствующим образом обновляем
                let winnerSymbol = '';
                if (lastStatus.includes(translations['ru'].player_x_wins.split(' ')[0]) || lastStatus.includes(translations['en'].player_x_wins.split(' ')[0]) ||
                    lastStatus.includes(translations['es'].player_x_wins.split(' ')[0]) || lastStatus.includes(translations['pt'].player_x_wins.split(' ')[0]) ||
                    lastStatus.includes(translations['it'].player_x_wins.split(' ')[0])) {
                    winnerSymbol = 'X';
                } else if (lastStatus.includes(translations['ru'].player_o_wins.split(' ')[0]) || lastStatus.includes(translations['en'].player_o_wins.split(' ')[0]) ||
                           lastStatus.includes(translations['es'].player_o_wins.split(' ')[0]) || lastStatus.includes(translations['pt'].player_o_wins.split(' ')[0]) ||
                           lastStatus.includes(translations['it'].player_o_wins.split(' ')[0])) {
                    winnerSymbol = 'O';
                }

                if (winnerSymbol === 'X') {
                    statusDisplay.textContent = `${translations[currentLanguage].player_x_wins} ${duration} ${translations[currentLanguage].seconds}`;
                } else if (winnerSymbol === 'O') {
                    statusDisplay.textContent = `${translations[currentLanguage].player_o_wins} ${duration} ${translations[currentLanguage].seconds}`;
                } else if (lastStatus.includes(translations['ru'].draw.split(' ')[0]) || lastStatus.includes(translations['en'].draw.split(' ')[0]) ||
                           lastStatus.includes(translations['es'].draw.split(' ')[0]) || lastStatus.includes(translations['pt'].draw.split(' ')[0]) ||
                           lastStatus.includes(translations['it'].draw.split(' ')[0])) {
                    statusDisplay.textContent = `${translations[currentLanguage].draw} ${duration} ${translations[currentLanguage].seconds}`;
                }
            }


            document.getElementById('resetButtonGame').textContent = translations[currentLanguage].start_new;
            document.getElementById('backToMenuGame').textContent = translations[currentLanguage].back_to_menu;

            document.getElementById('historyTitle').textContent = translations[currentLanguage].history_title;
            document.getElementById('clearHistoryButton').textContent = translations[currentLanguage].clear_history;
            document.getElementById('backToMenuHistory').textContent = translations[currentLanguage].back_to_menu;

            document.getElementById('themesTitle').textContent = translations[currentLanguage].themes_title;
            document.getElementById('eventThemesTitle').textContent = translations[currentLanguage].event_themes;
            document.getElementById('ordinaryThemesTitle').textContent = translations[currentLanguage].ordinary_themes;
            document.getElementById('specialThemesTitle').textContent = translations[currentLanguage].special_themes;
            document.getElementById('backToMenuThemes').textContent = translations[currentLanguage].back_to_menu;

            document.getElementById('settingsTitle').textContent = translations[currentLanguage].settings_title;
            document.getElementById('languageSettingsTitle').textContent = translations[currentLanguage].language;
            currentLanguageDisplay.textContent = languageNames[currentLanguage];
            document.getElementById('supportButton').textContent = translations[currentLanguage].write_to_support;
            document.getElementById('applySettingsButton').textContent = translations[currentLanguage].apply;
            document.getElementById('backToMenuSettings').textContent = translations[currentLanguage].back_to_menu;

            // Модальные окна
            languageModalTitle.textContent = translations[currentLanguage].select_your_language;

            document.getElementById('clearHistoryConfirmTitle').textContent = translations[currentLanguage].confirm_clear_history;
            document.getElementById('confirmClearHistoryButton').textContent = translations[currentLanguage].yes_clear;
            document.querySelector('#clearHistoryConfirmModal .back-button').textContent = translations[currentLanguage].cancel;

            document.getElementById('cancelSettingsConfirmTitle').textContent = translations[currentLanguage].confirm_cancel_settings;
            document.getElementById('cancelSettingsStayButton').textContent = translations[currentLanguage].cancel;
            document.getElementById('cancelSettingsDiscardButton').textContent = translations[currentLanguage].discard;

            // Новые элементы для выбора игры
            document.getElementById('selectGameModeTitle').textContent = translations[currentLanguage].select_game_mode;
            document.getElementById('ticTacToeButton').textContent = translations[currentLanguage].tic_tac_toe;
            document.getElementById('ticTacToeBlastButton').textContent = translations[currentLanguage].tic_tac_toe_blast;

            document.getElementById('selectGamePlayModeTitle').textContent = translations[currentLanguage].select_game_play_mode;
            document.getElementById('playOnPhoneButton').textContent = translations[currentLanguage].play_on_phone;
            document.getElementById('playViaWifiButton').textContent = translations[currentLanguage].play_via_wifi;
            document.getElementById('playViaBluetoothButton').textContent = translations[currentLanguage].play_via_bluetooth;

            document.getElementById('selectBoardSizeTitle').textContent = translations[currentLanguage].select_board_size;
            document.getElementById('customBoardLabel').textContent = translations[currentLanguage].custom_board;
            customWidthInput.placeholder = translations[currentLanguage].width;
            customHeightInput.placeholder = translations[currentLanguage].height;
            document.getElementById('createCustomBoardButton').textContent = translations[currentLanguage].create_board;
            document.getElementById('startGameFinalButton').textContent = translations[currentLanguage].start_game;

            cancelGameCreationConfirmTitle.textContent = translations[currentLanguage].confirm_cancel_game_creation;
            cancelGameCreationStayButton.textContent = translations[currentLanguage].continue_creation;
            cancelGameCreationDiscardButton.textContent = translations[currentLanguage].abort_creation;

            // Обновляем список истории, так как текст там тоже меняется
            if (document.getElementById('historyScreen').classList.contains('active')) {
                loadHistory();
            }
            // Обновляем названия тем в сетке тем
            if (document.getElementById('themesScreen').classList.contains('active')) {
                populateThemesGrid(); // Это перезаполнит сетку и обновит названия тем
            }
        }


        function populateLanguageOptions(container, selectedLang, onClickHandler) {
            container.innerHTML = '';
            for (const langCode in languageNames) {
                const langOption = document.createElement('div');
                langOption.classList.add('language-option');
                if (langCode === selectedLang) {
                    langOption.classList.add('selected-lang');
                }
                langOption.dataset.lang = langCode;
                langOption.textContent = languageNames[langCode];
                langOption.addEventListener('click', () => {
                    onClickHandler(langCode);
                    Array.from(container.children).forEach(child => child.classList.remove('selected-lang'));
                    langOption.classList.add('selected-lang');
                });
                container.appendChild(langOption);
            }
        }

        // --- Модальные окна ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
        }

        function showNotification(messageKey) {
            notificationModalTitle.textContent = translations[currentLanguage][messageKey];
            openModal('notificationModal');
        }

        // --- Логика настроек ---
        let originalSettingsLanguage = currentLanguage;

        applySettingsButton.addEventListener('click', () => {
            applyLanguage(tempSettingsLanguage);
            originalSettingsLanguage = tempSettingsLanguage;
            showScreen('mainMenuScreen');
        });

        function confirmCancelSettings() {
            if (tempSettingsLanguage !== originalSettingsLanguage) {
                openModal('cancelSettingsConfirmModal');
            } else {
                showScreen('mainMenuScreen');
            }
        }

        cancelSettingsStayButton.addEventListener('click', () => {
            closeModal('cancelSettingsConfirmModal');
            populateLanguageOptions(settingsLanguageOptionsContainer, tempSettingsLanguage, (lang) => {
                tempSettingsLanguage = lang;
                currentLanguageDisplay.textContent = languageNames[tempSettingsLanguage];
            });
        });

        cancelSettingsDiscardButton.addEventListener('click', () => {
            closeModal('cancelSettingsConfirmModal');
            tempSettingsLanguage = originalSettingsLanguage;
            showScreen('mainMenuScreen');
            applyLanguage(originalSettingsLanguage);
        });

        supportButton.addEventListener('click', () => {
            window.location.href = 'mailto:unluckymoderator@gmail.com';
        });

        // --- Логика выбора игры ---
        playButton.addEventListener('click', () => showScreen('gameModeSelectionScreen'));

        ticTacToeButton.addEventListener('click', () => showScreen('gamePlayModeSelectionScreen'));
        ticTacToeBlastButton.addEventListener('click', () => showNotification('mode_under_development'));

        playOnPhoneButton.addEventListener('click', () => {
            currentBoardWidth = predefinedBoardSizes[currentBoardSizeIndex].width;
            currentBoardHeight = predefinedBoardSizes[currentBoardSizeIndex].height;
            showScreen('boardSizeSelectionScreen');
        });
        playViaWifiButton.addEventListener('click', () => showNotification('network_under_development'));
        playViaBluetoothButton.addEventListener('click', () => showNotification('network_under_development'));

        // Логика выбора размера доски
        function updateBoardSizeDisplay() {
            currentBoardSizeDisplay.textContent = `${currentBoardWidth}x${currentBoardHeight}`;
        }

        prevBoardSizeButton.addEventListener('click', () => {
            currentBoardSizeIndex = (currentBoardSizeIndex - 1 + predefinedBoardSizes.length) % predefinedBoardSizes.length;
            currentBoardWidth = predefinedBoardSizes[currentBoardSizeIndex].width;
            currentBoardHeight = predefinedBoardSizes[currentBoardSizeIndex].height;
            updateBoardSizeDisplay();
        });

        nextBoardSizeButton.addEventListener('click', () => {
            currentBoardSizeIndex = (currentBoardSizeIndex + 1) % predefinedBoardSizes.length;
            currentBoardWidth = predefinedBoardSizes[currentBoardSizeIndex].width;
            currentBoardHeight = predefinedBoardSizes[currentBoardSizeIndex].height;
            updateBoardSizeDisplay();
        });

        createCustomBoardButton.addEventListener('click', (e) => {
            e.preventDefault();
            const width = parseInt(customWidthInput.value);
            const height = parseInt(customHeightInput.value);

            if (isNaN(width) || isNaN(height) || width < 3 || width > 15 || height < 3 || height > 15) {
                showNotification('invalid_board_size');
                return;
            }
            currentBoardWidth = width;
            currentBoardHeight = height;
            currentBoardSizeDisplay.textContent = `${currentBoardWidth}x${currentBoardHeight}`; // Обновляем дисплей
            // Очищаем поля после успешного создания
            customWidthInput.value = '';
            customHeightInput.value = '';
        });

        startGameFinalButton.addEventListener('click', () => {
            showScreen('gameScreen', true); // Начинаем игру с выбранным размером
        });


        // Логика подтверждения отмены создания игры
        let currentScreenBeforeCancel = '';
        function confirmCancelGameCreation(screenToReturn) {
            currentScreenBeforeCancel = screenToReturn;
            openModal('cancelGameCreationConfirmModal');
        }

        cancelGameCreationStayButton.addEventListener('click', () => {
            closeModal('cancelGameCreationConfirmModal');
            // Остаемся на текущем экране, который вызвал модалку
        });

        cancelGameCreationDiscardButton.addEventListener('click', () => {
            closeModal('cancelGameCreationConfirmModal');
            // Возвращаемся в главное меню
            showScreen('mainMenuScreen');
        });


        // --- Инициализация ---
        function init() {
            const hasChosenLanguage = localStorage.getItem('ticTacToeLanguageChosen');
            if (!hasChosenLanguage) {
                showScreen('mainMenuScreen'); // Показываем главное меню, чтобы PWA сразу запустилось
                openModal('languageModal');
                // Заголовок модального окна выбора языка
                languageModalTitle.textContent = translations['ru'].select_your_language + ' / ' +
                                                  translations['en'].select_your_language + ' / ' +
                                                  translations['es'].select_your_language + ' / ' +
                                                  translations['pt'].select_your_language + ' / ' +
                                                  translations['it'].select_your_language;

                populateLanguageOptions(firstTimeLanguageOptions, null, (lang) => {
                    applyLanguage(lang);
                    localStorage.setItem('ticTacToeLanguageChosen', 'true');
                    closeModal('languageModal');
                    // showScreen('mainMenuScreen'); // Уже установлен как активный
                });
            } else {
                applyLanguage(currentLanguage); // Применяем сохраненный язык
                showScreen('mainMenuScreen'); // Показываем главное меню
            }

            // Загружаем сохраненную тему при загрузке страницы
            applyTheme(localStorage.getItem('ticTacToeTheme') || 'default');
            populateThemesGrid(); // Вызываем здесь, чтобы сетка тем правильно отрисовалась при старте
            startGame(currentBoardWidth, currentBoardHeight); // Инициализируем доску 3x3 при первом запуске
        }

        // --- Регистрация Service Worker для PWA ---
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', function() {
            navigator.serviceWorker.register('/service-worker.js')
              .then(registration => {
                console.log('Service Worker успешно зарегистрирован:', registration);
              })
              .catch(error => {
                console.log('Ошибка регистрации Service Worker:', error);
              });
          });
        }

        // Запуск инициализации при загрузке DOM
        document.addEventListener('DOMContentLoaded', init);

        // Обновление размеров доски при изменении размера окна
        window.addEventListener('resize', () => {
            if (document.getElementById('gameScreen').classList.contains('active') && gameActive) {
                // Если игра активна, перерисовываем доску с текущим размером
                startGame(currentBoardWidth, currentBoardHeight);
            }
        });

    </script>
</body>
</html>