<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Крестики-Нолики Deluxe</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1f2937">

    <style>
        :root {
            --main-bg: #1f2937; /* Темно-серый */
            --container-bg: #374151; /* Средне-серый */
            --button-bg: #4f46e5; /* Ярко-фиолетовый */
            --button-hover-bg: #6366f1;
            --x-color: #ef4444; /* Ярко-красный */
            --o-color: #3b82f6; /* Ярко-синий */
            --text-color: #f3f4f6; /* Очень светло-серый */
            --border-color: #6b7280; /* Серый для линий */
            --shadow-color: rgba(0, 0, 0, 0.6);
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;

            /* Переменные для фона тела */
            --body-bg-start: #111827;
            --body-bg-end: var(--main-bg);
            --body-bg-direction: 135deg;
            --body-bg-size: auto; /* Используется для анимации */
            --body-bg-animation: none; /* Используется для анимации */
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            /* Фон теперь управляется переменными */
            background: linear-gradient(var(--body-bg-direction), var(--body-bg-start) 0%, var(--body-bg-end) 100%);
            background-size: var(--body-bg-size); /* Для анимации */
            animation: var(--body-bg-animation); /* Для анимация */

            font-family: var(--font-family);
            color: var(--text-color);
            overflow: hidden;
            transition: background 0.5s ease; /* Плавный переход между фонами */
        }

        /* Анимация фона (применяется, если --body-bg-animation не 'none') */
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }


        .screen {
            display: none; /* Скрываем все экраны по умолчанию */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 90%;
            max-width: 500px;
            padding: 25px;
            background-color: var(--container-bg);
            border-radius: 20px;
            box-shadow: 0 20px 40px var(--shadow-color);
            text-align: center;
        }

        .screen.active {
            display: flex; /* Показываем активный экран */
        }

        h1, h2 {
            color: var(--text-color);
            text-shadow: 0 0 8px rgba(255,255,255,0.3);
        }
        h1 { font-size: 2.8em; margin-bottom: 30px; }
        h2 { font-size: 2em; margin-bottom: 20px; }


        .menu-button, .back-button {
            background-color: var(--button-bg);
            color: var(--text-color);
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            margin: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
            width: 250px;
            text-align: center;
        }

        .menu-button:hover, .back-button:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-3px);
        }

        /* Стили для игрового поля */
        .board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 300px;
            height: 300px;
            gap: 8px;
            background-color: var(--main-bg);
            padding: 8px;
            border-radius: 12px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.4), 0 3px 8px var(--shadow-color);
            margin-bottom: 20px;
        }

        .cell {
            background-color: var(--container-bg); /* Темнее, чем фон контейнера игры */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2) inset, 0 1px 1px rgba(255,255,255,0.05);
        }

        .cell:hover {
            background-color: #4b5563; /* Чуть светлее при наведении */
        }

        /* Цвет и стиль символов зависят от текущей темы */
        .cell.x { color: var(--x-color); text-shadow: 0 0 7px var(--x-color), 0 0 3px black; }
        .cell.o { color: var(--o-color); text-shadow: 0 0 7px var(--o-color), 0 0 3px black; }

        .cell.x::before, .cell.o::before {
            opacity: 0;
            transform: scale(0.5);
            animation: appear 0.3s ease-out forwards;
            /* Содержимое символов остается X и O */
        }
        /* Здесь мы не используем ::before для символов, так как они могут быть кастомными (эмодзи, цифры).
           Вместо этого текст будет вставляться прямо в span внутри ячейки. */


        @keyframes appear {
            to { opacity: 1; transform: scale(1); }
        }

        .status {
            margin-bottom: 15px;
            font-size: 1.4em;
            min-height: 1.4em;
            /* Цвет статуса тоже можно менять в темах */
        }

        button#resetButtonGame { /* Переименована для уникальности */
             /* Фон кнопки с градиентом X и O - можно менять в темах */
            background: linear-gradient(145deg, var(--x-color), var(--o-color));
            color: var(--text-color);
            border: none;
            border-radius: 10px;
            padding: 12px 25px;
            font-size: 1.1em;
            font-weight: bold;
            margin-top:10px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s ease; /* Добавлен переход для фона */
            box-shadow: 0 4px 8px var(--shadow-color);
        }
        button#resetButtonGame:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 12px var(--shadow-color);
        }


        .audio-controls {
            margin-top: 20px;
        }
        audio {
            border-radius: 25px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px var(--shadow-color);
            width: 100%;
            max-width: 300px;
        }

        /* История игр */
        #historyList {
            list-style: none;
            padding: 0;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        #historyList li {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            background-color: #4b5563; /* Этот цвет тоже можно вынести в переменные темы */
        }
        #historyList li:last-child {
            border-bottom: none;
        }
        #historyList li:nth-child(odd) {
            background-color: var(--container-bg); /* Этот цвет тоже можно вынести в переменные темы */
        }

        /* Настройки - Динозавр */
        .dino-builder {
            font-family: monospace;
            white-space: pre;
            font-size: 1.2em; /* Размер дино можно подстроить */
            line-height: 1;
            color: #2ecc71; /* Зеленый дино */
            margin: 20px 0;
            padding:10px;
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            background-color: rgba(0,0,0,0.2);
        }
        .settings-message {
            font-size: 1.3em;
            margin-top: 10px;
            color: #f1c40f; /* Желтый для сообщения */
        }

        /* --- Стили для экрана Тем --- */
        #themesScreen .themes-category {
            width: 100%;
            margin-bottom: 25px; /* Отступ между категориями */
        }
        #themesScreen .themes-category h3 {
            color: var(--text-color);
            font-size: 1.6em;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 5px;
            text-align: left;
            width: 100%;
        }

        #themesScreen .themes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Адаптивная сетка */
            gap: 15px;
            width: 100%;
            /* margin-bottom: 20px; */ /* Перемещено в .themes-category */
        }

        #themesScreen .themes-container { /* Новый контейнер для прокрутки */
            width: 100%;
            max-height: 400px; /* Максимальная высота для прокрутки */
            overflow-y: auto; /* Включаем прокрутку */
            padding-right: 10px; /* Отступ для полосы прокрутки */
            box-sizing: border-box; /* Учитываем padding в ширине */
        }
        /* Стилизация полосы прокрутки (Webkit) */
        #themesScreen .themes-container::-webkit-scrollbar {
            width: 8px;
        }
        #themesScreen .themes-container::-webkit-scrollbar-track {
            background: #374151; /* Цвет трека */
            border-radius: 10px;
        }
        #themesScreen .themes-container::-webkit-scrollbar-thumb {
            background: var(--button-bg); /* Цвет ползунка */
            border-radius: 10px;
        }
        #themesScreen .themes-container::-webkit-scrollbar-thumb:hover {
            background: var(--button-hover-bg);
        }


        #themesScreen .theme-option {
            background-color: var(--main-bg); /* Фон кнопки темы */
            border: 2px solid var(--border-color); /* Рамка */
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1em;
            font-weight: bold;
            color: var(--text-color); /* Цвет текста названия темы */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        #themesScreen .theme-option:hover {
            transform: translateY(-3px);
            border-color: var(--button-hover-bg); /* Подсветка рамки при наведении */
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

         #themesScreen .theme-option.selected {
            border-color: var(--button-bg); /* Яркая рамка для выбранной темы */
            transform: scale(1.05); /* Немного увеличить выбранную тему */
            box-shadow: 0 0 15px var(--button-bg), 0 0 8px var(--button-bg); /* Сияние выбранной темы */
        }


        #themesScreen .theme-preview {
            width: 60px; /* Размер превью */
            height: 60px;
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative; /* Для позиционирования символов внутри */
            overflow: hidden; /* Скрываем, если символы выходят за границы */
            background-color: var(--container-bg); /* Фон превью */
            display: flex; /* Для центрирования, если символ один */
            align-items: center;
            justify-content: center;
            font-size: 2.5em; /* Общий размер для чисел/эмодзи */
        }

        #themesScreen .theme-preview .preview-x,
        #themesScreen .theme-preview .preview-o {
            position: absolute; /* Для позиционирования символов X и O */
            font-size: 1.8em; /* Размер символов в превью */
            font-weight: bold;
            text-shadow: 0 0 4px rgba(0,0,0,0.5);
            /* animation: appear 0.3s ease-out forwards; */ /* Анимация не нужна для превью */
        }
        #themesScreen .theme-preview .preview-x {
            color: var(--preview-x-color); /* Цвет X для превью */
            top: 5px; left: 5px;
        }
        #themesScreen .theme-preview .preview-o {
            color: var(--preview-o-color); /* Цвет O для превью */
            bottom: 5px; right: 5px;
        }
        /* Специальные стили для "скучных уроков" */
        #themesScreen .theme-preview.boring-lessons .preview-x {
             color: black; /* Черный для карандаша */
             font-weight: normal; /* Более тонкий шрифт */
             opacity: 0.8; /* Полупрозрачность */
             transform: scaleX(0.8) rotate(-45deg); /* Имитация крестика карандашом */
        }
        #themesScreen .theme-preview.boring-lessons .preview-o {
             color: black;
             font-weight: normal;
             opacity: 0.8;
             transform: scale(0.9); /* Сделать чуть меньше, чтобы выглядело нарисованным */
        }

        /* Стили для текста версии */
        #versionText {
            margin-top: 20px;
            font-size: 1em;
            color: rgba(255, 255, 255, 0.6); /* Прозрачно-беловатый */
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
        }

    </style>
</head>
<body>

    <div id="mainMenuScreen" class="screen active">
        <h1>Крестики-Нолики Deluxe</h1>
        <button class="menu-button" onclick="showScreen('gameScreen'); startGame();">Играть</button>
        <button class="menu-button" onclick="showScreen('historyScreen'); loadHistory();">История игр</button>
        <button class="menu-button" onclick="showScreen('themesScreen')">Темы</button>
        <button class="menu-button" onclick="showScreen('settingsScreen')">Настройки</button>
        <p id="versionText">Version: 1</p>
    </div>

    <div id="gameScreen" class="screen">
        <h2>Крестики-Нолики</h2>
        <div class="status" id="status">Ход игрока X</div>
        <div class="board" id="board">
            </div>
        <button id="resetButtonGame">Начать заново</button>
        <button class="back-button" onclick="showScreen('mainMenuScreen')">В меню</button>
    </div>

    <div id="historyScreen" class="screen">
        <h2>История побед</h2>
        <ul id="historyList">
            </ul>
        <button class="back-button" onclick="showScreen('mainMenuScreen')">В меню</button>
    </div>

    <div id="settingsScreen" class="screen">
        <h2>Настройки</h2>
        <div class="dino-builder">
          /\_/\
         / o o \
        (  (_Y_)  )
         \ \   / / Я строитель!
          \ '-' /  []--[]
           '---'  [][][]
        </div>
        <p class="settings-message">Простите, я случайно все сломал... <br>(Настройки в разработке!)</p>
        <button class="back-button" onclick="showScreen('mainMenuScreen')">В меню</button>
    </div>

    <div id="themesScreen" class="screen">
        <h2>Выбор Темы</h2>
        <div class="themes-container"> <div id="ordinaryThemes" class="themes-category">
                <h3>Обычные</h3>
                <div class="themes-grid">
                    </div>
            </div>

            <div id="specialThemes" class="themes-category">
                <h3>Особые</h3>
                <div class="themes-grid">
                    </div>
            </div>
        </div>
        <button class="back-button" onclick="showScreen('mainMenuScreen')">В меню</button>
    </div>

    <script>
        // Элементы DOM
        const screens = document.querySelectorAll('.screen');
        const boardElement = document.getElementById('board');
        const statusDisplay = document.getElementById('status');
        const resetButtonGame = document.getElementById('resetButtonGame');
        // const backgroundMusic = document.getElementById('backgroundMusic'); // Удален
        const historyListElement = document.getElementById('historyList');
        const ordinaryThemesGridElement = document.querySelector('#ordinaryThemes .themes-grid'); // Элемент для обычных тем
        const specialThemesGridElement = document.querySelector('#specialThemes .themes-grid'); // Элемент для особых тем
        const root = document.documentElement; // Доступ к CSS переменным

        // Состояние игры
        let currentPlayer = 'X';
        let gameActive = true;
        let gameState = ["", "", "", "", "", "", "", "", ""];
        let gameStartTime;
        let gameHistory = JSON.parse(localStorage.getItem('ticTacToeHistory')) || [];

        const winningConditions = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8],
            [0, 3, 6], [1, 4, 7], [2, 5, 8],
            [0, 4, 8], [2, 4, 6]
        ];

         // --- Определение Тем ---
         const themes = {
             'default': {
                 name: 'По Умолчанию',
                 category: 'ordinary',
                 vars: {
                    '--main-bg': '#1f2937',
                    '--container-bg': '#374151',
                    '--button-bg': '#4f46e5',
                    '--button-hover-bg': '#6366f1',
                    '--x-color': '#ef4444',
                    '--o-color': '#3b82f6',
                    '--text-color': '#f3f4f6',
                    '--border-color': '#6b7280',
                    '--shadow-color': 'rgba(0, 0, 0, 0.6)',
                    '--body-bg-start': '#111827',
                    '--body-bg-end': '#1f2937',
                    '--body-bg-direction': '135deg',
                    '--body-bg-size': 'auto',
                    '--body-bg-animation': 'none',
                 },
                 marks: { x: 'X', o: 'O' }, // Используем для кастомных символов
                 preview: { '--preview-x-color': '#ef4444', '--preview-o-color': '#3b82f6' }
             },
             'forest': {
                 name: 'Лес',
                 category: 'ordinary',
                 vars: {
                    '--main-bg': '#1e3a24', /* Темно-зеленый */
                    '--container-bg': '#224d2b', /* Средне-зеленый */
                    '--button-bg': '#346c41', /* Зеленая кнопка */
                    '--button-hover-bg': '#4a805a',
                    '--x-color': '#facc15', /* Золотистый */
                    '--o-color': '#a7f3d0', /* Светло-зеленый */
                    '--text-color': '#d1fae5', /* Очень светло-зеленый */
                    '--border-color': '#4b5563', /* Серый */
                    '--shadow-color': 'rgba(0, 0, 0, 0.6)',
                    '--body-bg-start': '#064e3b', /* Темно-изумрудный */
                    '--body-bg-end': '#1e3a24',
                    '--body-bg-direction': 'top right',
                    '--body-bg-size': 'auto',
                    '--body-bg-animation': 'none',
                 },
                 marks: { x: 'X', o: 'O' },
                 preview: { '--preview-x-color': '#facc15', '--preview-o-color': '#a7f3d0' }
             },
             'ocean': {
                 name: 'Океан',
                 category: 'ordinary',
                 vars: {
                    '--main-bg': '#1e3a8a', /* Темно-синий */
                    '--container-bg': '#1c4a7b', /* Средне-синий */
                    '--button-bg': '#2563eb', /* Голубая кнопка */
                    '--button-hover-bg': '#3b82f6',
                    '--x-color': '#f87171', /* Коралл */
                    '--o-color': '#bfdbfe', /* Очень светло-голубой */
                    '--text-color': '#eff6ff', /* Почти белый */
                    '--border-color': '#60a5fa', /* Светло-синий */
                    '--shadow-color': 'rgba(0, 0, 0, 0.6)',
                    '--body-bg-start': '#0b173b', /* Очень темно-синий */
                    '--body-bg-end': '#1e3a8a',
                    '--body-bg-direction': 'bottom left',
                    '--body-bg-size': 'auto',
                    '--body-bg-animation': 'none',
                 },
                 marks: { x: 'X', o: 'O' },
                 preview: { '--preview-x-color': '#f87171', '--preview-o-color': '#bfdbfe' }
             },
              'lava': {
                 name: 'Лава',
                 category: 'ordinary',
                 vars: {
                    '--main-bg': '#450a0a', /* Темно-бордовый */
                    '--container-bg': '#7f1d1d', /* Красно-коричневый */
                    '--button-bg': '#dc2626', /* Красная кнопка */
                    '--button-hover-bg': '#ef4444',
                    '--x-color': '#fef08a', /* Очень светло-желтый */
                    '--o-color': '#f97316', /* Оранжевый */
                    '--text-color': '#fef2f2', /* Почти белый */
                    '--border-color': '#b91c1c', /* Темно-красный */
                    '--shadow-color': 'rgba(0, 0, 0, 0.8)',
                    '--body-bg-start': '#0c0606', /* Почти черный */
                    '--body-bg-end': '#450a0a',
                    '--body-bg-direction': 'to top',
                    '--body-bg-size': '600% 600%', /* Увеличиваем размер для анимации */
                    '--body-bg-animation': 'gradientShift 30s ease infinite', /* Включаем анимацию для этой темы */
                 },
                 marks: { x: 'X', o: 'O' },
                 preview: { '--preview-x-color': '#fef08a', '--preview-o-color': '#f97316' }
             },
             'excellent-poor': { // Новая тема: Отличник против двоечника
                 name: 'Отличник vs Двоечник',
                 category: 'special',
                 vars: {
                    '--main-bg': '#ffffff', /* Временно белый фон */
                    '--container-bg': '#f0f0f0',
                    '--button-bg': '#4CAF50', /* Зеленая кнопка */
                    '--button-hover-bg': '#66BB6A',
                    '--x-color': '#ef4444', /* Красная */
                    '--o-color': '#3b82f6', /* Синяя */
                    '--text-color': '#333333', /* Темный текст на светлом фоне */
                    '--border-color': '#cccccc',
                    '--shadow-color': 'rgba(0, 0, 0, 0.2)',
                    '--body-bg-start': '#ffffff', /* Временно белый фон */
                    '--body-bg-end': '#f0f0f0',
                    '--body-bg-direction': '135deg',
                    '--body-bg-size': 'auto',
                    '--body-bg-animation': 'none',
                 },
                 marks: { x: '2', o: '5' }, // Символы 2 и 5
                 preview: { '--preview-x-color': '#ef4444', '--preview-o-color': '#3b82f6' }
             },
             'stars-moon': {
                 name: 'Звезды и Луна',
                 category: 'special', // Эта тема теперь особая
                 vars: {
                    '--main-bg': '#0a0a23', /* Очень темный синий/черный */
                    '--container-bg': '#1a1a3b', /* Темно-фиолетовый */
                    '--button-bg': '#3a245c', /* Темно-фиолетовый */
                    '--button-hover-bg': '#5a3b8d', /* Чуть светлее фиолетовый */
                    '--x-color': '#ffffa0', /* Светло-желтый (цвет звезды) */
                    '--o-color': '#f0f0f0', /* Белый/очень светло-серый (цвет луны) */
                    '--text-color': '#e0e0ff', /* Светло-голубой/фиолетовый */
                    '--border-color': '#404060', /* Темно-серый/синий */
                    '--shadow-color': 'rgba(0, 0, 0, 0.8)',
                    '--body-bg-start': '#000000', /* Черный космос */
                    '--body-bg-end': '#1a1a3b',
                    '--body-bg-direction': 'to bottom right',
                    '--body-bg-size': 'auto',
                    '--body-bg-animation': 'none', /* Без анимации фона по умолчанию */
                 },
                 marks: { x: 'X', o: 'O' }, // Используем X и O по умолчанию
                 preview: { '--preview-x-color': '#ffffa0', '--preview-o-color': '#f0f0f0' }
             },
             'stars-moon-emoji': { // Новая тема: Звезды и Луна Эмодзи версия
                 name: 'Звезды и Луна (Эмодзи)',
                 category: 'special',
                 vars: {
                    // Используем те же переменные, что и у обычной темы "Звезды и Луна"
                    '--main-bg': '#0a0a23',
                    '--container-bg': '#1a1a3b',
                    '--button-bg': '#3a245c',
                    '--button-hover-bg': '#5a3b8d',
                    // Цвета X и O здесь не так важны, так как это эмодзи,
                    // но они могут использоваться для статуса
                    '--x-color': '#ffffa0',
                    '--o-color': '#f0f0f0',
                    '--text-color': '#e0e0ff',
                    '--border-color': '#404060',
                    '--shadow-color': 'rgba(0, 0, 0, 0.8)',
                    '--body-bg-start': '#000000',
                    '--body-bg-end': '#1a1a3b',
                    '--body-bg-direction': 'to bottom right',
                    '--body-bg-size': 'auto',
                    '--body-bg-animation': 'none',
                 },
                 marks: { x: '⭐', o: '🌕' }, // Эмодзи звезды и полной луны
                 preview: { '--preview-x-color': '#ffffa0', '--preview-o-color': '#f0f0f0' }
             },
             'boring-lessons': { // Новая тема: Скучные уроки
                 name: 'Скучные Уроки',
                 category: 'ordinary',
                 vars: {
                    '--main-bg': '#ffffff', /* Временно белый фон */
                    '--container-bg': '#f0f0f0',
                    '--button-bg': '#6b7280', /* Серый как карандаш */
                    '--button-hover-bg': '#9ca3af',
                    '--x-color': 'black', /* Черный для карандаша */
                    '--o-color': 'black', /* Черный для карандаша */
                    '--text-color': '#333333',
                    '--border-color': '#cccccc',
                    '--shadow-color': 'rgba(0, 0, 0, 0.2)',
                    '--body-bg-start': '#ffffff', /* Временно белый фон */
                    '--body-bg-end': '#f0f0f0',
                    '--body-bg-direction': '135deg',
                    '--body-bg-size': 'auto',
                    '--body-bg-animation': 'none',
                 },
                 marks: { x: 'X', o: 'O' }, // Здесь стилизация будет через CSS для имитации карандаша
                 preview: { '--preview-x-color': 'black', '--preview-o-color': 'black' }
             },
             'water-vs-lava': { // Новая тема: Вода против Лавы
                 name: 'Вода vs Лава',
                 category: 'ordinary',
                 vars: {
                    '--main-bg': '#ff4500', /* Начальный оранжевый */
                    '--container-bg': '#4169e1', /* Синий */
                    '--button-bg': 'linear-gradient(90deg, #ff4500, #4169e1)',
                    '--button-hover-bg': 'linear-gradient(90deg, #ff6347, #6a5acd)',
                    '--x-color': '#ff4500', /* Оранжевый */
                    '--o-color': '#4169e1', /* Синий */
                    '--text-color': '#f3f4f6',
                    '--border-color': '#808080',
                    '--shadow-color': 'rgba(0, 0, 0, 0.6)',
                    '--body-bg-start': '#ff4500', /* Оранжевый */
                    '--body-bg-end': '#4169e1', /* Синий */
                    '--body-bg-direction': '45deg', /* Направление градиента */
                    '--body-bg-size': '200% 200%', /* Увеличиваем для плавного перелива */
                    '--body-bg-animation': 'gradientShift 20s ease infinite alternate', /* Анимация перелива */
                 },
                 marks: { x: 'X', o: 'O' },
                 preview: { '--preview-x-color': '#ff4500', '--preview-o-color': '#4169e1' }
             }
         };

        let currentThemeKey = localStorage.getItem('ticTacToeTheme') || 'default';


        // --- Управление экранами ---
        function showScreen(screenId) {
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            // Музыка больше не управляется напрямую отсюда
        }

        // --- Логика игры ---
        function startGame() {
            boardElement.innerHTML = ''; // Очищаем доску
            gameState = ["", "", "", "", "", "", "", "", ""];
            currentPlayer = 'X';
            gameActive = true;
            statusDisplay.textContent = `Ход игрока ${currentPlayer}`;
             // Обновляем цвет статуса в зависимости от текущей темы и игрока
            statusDisplay.style.color = root.style.getPropertyValue(currentPlayer === 'X' ? '--x-color' : '--o-color');

            gameStartTime = new Date();

            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                cell.dataset.index = i;
                cell.addEventListener('click', handleCellClick);
                boardElement.appendChild(cell);
            }
             // Музыка больше не воспроизводится при старте игры
        }

        function handleCellClick(event) {
            const clickedCell = event.target;
            const clickedCellIndex = parseInt(clickedCell.dataset.index);

            // --- ПРОВЕРКА НА ЗАНЯТОСТЬ ЯЧЕЙКИ ---
            if (gameState[clickedCellIndex] !== "" || !gameActive) {
                return;
            }
            // --- КОНЕЦ ПРОВЕРКИ ---

            gameState[clickedCellIndex] = currentPlayer;

            // Получаем текущую тему, чтобы узнать, какой символ использовать
            const currentTheme = themes[currentThemeKey];
            const markToShow = currentPlayer === 'X' ? currentTheme.marks.x : currentTheme.marks.o;

            clickedCell.innerHTML = markToShow; // Вставляем кастомный символ
            clickedCell.classList.add(currentPlayer.toLowerCase()); // Добавляем класс 'x' или 'o'

            // Добавляем класс для "скучных уроков", чтобы применить специфичные стили
            if (currentThemeKey === 'boring-lessons') {
                clickedCell.classList.add('boring-lessons');
            }


            checkResult();
        }

        function checkResult() {
            let roundWon = false;
            for (let i = 0; i < winningConditions.length; i++) {
                const winCondition = winningConditions[i];
                let a = gameState[winCondition[0]];
                let b = gameState[winCondition[1]];
                let c = gameState[winCondition[2]];
                if (a === '' || b === '' || c === '') continue;
                if (a === b && b === c) {
                    roundWon = true;
                    break;
                }
            }

            const gameEndTime = new Date();
            const gameDuration = Math.round((gameEndTime - gameStartTime) / 1000); // в секундах

            if (roundWon) {
                statusDisplay.textContent = `Игрок ${currentPlayer} победил за ${gameDuration} сек!`;
                 statusDisplay.style.color = root.style.getPropertyValue(currentPlayer === 'X' ? '--x-color' : '--o-color');
                addHistoryRecord(`Игрок ${currentPlayer}`, gameDuration);
                gameActive = false;
                return;
            }

            if (!gameState.includes("")) {
                statusDisplay.textContent = `Ничья за ${gameDuration} сек!`;
                statusDisplay.style.color = root.style.getPropertyValue('--text-color'); // Цвет ничьей из темы
                addHistoryRecord('Ничья', gameDuration);
                gameActive = false;
                return;
            }

            currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
            statusDisplay.textContent = `Ход игрока ${currentPlayer}`;
             statusDisplay.style.color = root.style.getPropertyValue(currentPlayer === 'X' ? '--x-color' : '--o-color');
        }

        resetButtonGame.addEventListener('click', startGame);

        // --- История игр ---
        function addHistoryRecord(winner, duration) {
            const record = {
                winner: winner,
                duration: duration,
                date: new Date().toLocaleString('ru-RU')
            };
            gameHistory.unshift(record); // Добавляем в начало
            if (gameHistory.length > 20) { // Ограничиваем историю
                gameHistory.pop();
            }
            localStorage.setItem('ticTacToeHistory', JSON.stringify(gameHistory));
        }

        function loadHistory() {
            historyListElement.innerHTML = ''; // Очищаем список
            if (gameHistory.length === 0) {
                historyListElement.innerHTML = '<li>История пока пуста. Сыграйте партию!</li>';
                return;
            }
            gameHistory.forEach(record => {
                const listItem = document.createElement('li');
                listItem.textContent = `${record.date} - ${record.winner}, Длительность: ${record.duration} сек.`;
                historyListElement.appendChild(listItem);
            });
        }

         // --- Управление Темами ---
        function applyTheme(themeKey) {
            const theme = themes[themeKey];
            if (!theme) {
                console.error('Тема не найдена:', themeKey);
                return;
            }

            // Применяем CSS переменные темы
            for (const [prop, value] of Object.entries(theme.vars)) {
                root.style.setProperty(prop, value);
            }

            // Сохраняем выбранную тему в localStorage
            localStorage.setItem('ticTacToeTheme', themeKey);
            currentThemeKey = themeKey;

            // Обновляем активную тему в интерфейсе
            updateThemesUI();

            // Обновляем цвета в игровом поле, если оно активно
            const cells = boardElement.children;
            for (let i = 0; i < cells.length; i++) {
                const cell = cells[i];
                cell.classList.remove('x', 'o', 'boring-lessons'); // Удаляем старые классы
                if (gameState[i] !== "") { // Если ячейка не пустая
                    const player = gameState[i];
                    const markToShow = player === 'X' ? theme.marks.x : theme.marks.o;
                    cell.innerHTML = markToShow;
                    cell.classList.add(player.toLowerCase());
                    if (currentThemeKey === 'boring-lessons') {
                         cell.classList.add('boring-lessons');
                     }
                }
            }


            // Обновляем цвет статуса после смены темы (если находимся на игровом экране)
             if (document.getElementById('gameScreen').classList.contains('active')) {
                 if (gameActive) {
                     statusDisplay.style.color = root.style.getPropertyValue(currentPlayer === 'X' ? '--x-color' : '--o-color');
                 } else if (statusDisplay.textContent.includes('победил')) {
                      const winner = statusDisplay.textContent.includes('Игрок X') ? 'X' : 'O';
                      statusDisplay.style.color = root.style.getPropertyValue(winner === 'X' ? '--x-color' : '--o-color');
                 } else if (statusDisplay.textContent.includes('Ничья')) {
                      statusDisplay.style.color = root.style.getPropertyValue('--text-color');
                 }
             }
        }

        function populateThemesGrid() {
             ordinaryThemesGridElement.innerHTML = '';
             specialThemesGridElement.innerHTML = '';

             for (const themeKey in themes) {
                 const theme = themes[themeKey];
                 const optionDiv = document.createElement('div');
                 optionDiv.classList.add('theme-option');
                 optionDiv.dataset.themeKey = themeKey;

                 if (themeKey === currentThemeKey) {
                     optionDiv.classList.add('selected');
                 }

                 const previewDiv = document.createElement('div');
                 previewDiv.classList.add('theme-preview');
                 if (themeKey === 'boring-lessons') { // Добавляем спец. класс для стилей карандаша
                     previewDiv.classList.add('boring-lessons');
                 }

                 // Устанавливаем переменные для превью символов
                 previewDiv.style.setProperty('--preview-x-color', theme.preview['--preview-x-color']);
                 previewDiv.style.setProperty('--preview-o-color', theme.preview['--preview-o-color']);

                 // Используем marks.x и marks.o для отображения в превью
                 // Если это обычные X/O, то будут position:absolute
                 // Если это цифры/эмодзи, то будут центрированы как textContent
                 const previewX = document.createElement('span');
                 previewX.classList.add('preview-x');
                 previewX.textContent = theme.marks.x;

                 const previewO = document.createElement('span');
                 previewO.classList.add('preview-o');
                 previewO.textContent = theme.marks.o;

                 previewDiv.appendChild(previewX);
                 previewDiv.appendChild(previewO);


                 const nameSpan = document.createElement('span');
                 nameSpan.textContent = theme.name;

                 optionDiv.appendChild(previewDiv);
                 optionDiv.appendChild(nameSpan);

                 optionDiv.addEventListener('click', () => {
                     applyTheme(themeKey);
                 });

                 if (theme.category === 'ordinary') {
                     ordinaryThemesGridElement.appendChild(optionDiv);
                 } else if (theme.category === 'special') {
                     specialThemesGridElement.appendChild(optionDiv);
                 }
             }
        }

        function updateThemesUI() {
             const options = document.querySelectorAll('.theme-option'); // Ищем все опции тем
             options.forEach(option => {
                 if (option.dataset.themeKey === currentThemeKey) {
                     option.classList.add('selected');
                 } else {
                     option.classList.remove('selected');
                 }
             });
         }


        // --- Инициализация ---
        // Загружаем сохраненную тему при загрузке страницы
        applyTheme(localStorage.getItem('ticTacToeTheme') || 'default');

        // Заполняем сетку тем при первом показе или загрузке страницы
         populateThemesGrid();


        // --- Регистрация Service Worker для PWA (сохранено) ---
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', function() {
            navigator.serviceWorker.register('/service-worker.js') // Путь к файлу Service Worker
              .then(registration => {
                console.log('Service Worker успешно зарегистрирован:', registration);
              })
              .catch(error => {
                console.log('Ошибка регистрации Service Worker:', error);
              });
          });
        }

    </script>
</body>
</html>